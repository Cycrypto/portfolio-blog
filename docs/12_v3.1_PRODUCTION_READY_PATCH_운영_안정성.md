# v3.1 PRODUCTION READY PATCH - ìš´ì˜ ì•ˆì •ì„± ë³´ì™„

## ğŸ“‹ ë¬¸ì„œ ì •ë³´

- **ì‘ì„±ì¼**: 2025-12-30
- **ë²„ì „**: 3.1 PRODUCTION READY PATCH (ìš´ì˜ ì•ˆì •ì„± ì™„ì„±)
- **ì´ì „ ë²„ì „**: 3.1 PRODUCTION READY â†’ 6ê°œ ë°°í¬ ë¸”ë¡œì»¤ ìˆ˜ì •
- **ìƒíƒœ**: í”„ë¡œë•ì…˜ ë°°í¬ ê°€ëŠ¥ (ìš´ì˜ ê²€ì¦ ì™„ë£Œ)

---

## ğŸš¨ PRODUCTION READY PATCH ìˆ˜ì • ì‚¬í•­

| ë²ˆí˜¸ | ì´ìŠˆ | PRODUCTION READY ë¬¸ì œ | PATCH í•´ê²° |
|------|------|---------------------|-----------|
| **1** | Cookie SameSite | StrictëŠ” í¬ë¡œìŠ¤ì„œë¸Œë„ë©”ì¸ì—ì„œ ê¹¨ì§ | âœ… Laxë¡œ ë³€ê²½ (CSRFëŠ” Double Submitìœ¼ë¡œ ë³´í˜¸) |
| **2** | Server Action Cookie | `cookieStore.toString()` ê¹¨ì§ ê°€ëŠ¥ | âœ… ëª…ì‹œì  êµ¬ì„± (`auth-token=${token}`) |
| **3** | CSRF ìš´ì˜ ì „ëµ | í† í° ì¬ë°œê¸‰/ë§Œë£Œ ì •ì±… ì—†ìŒ | âœ… í”„ë¡ íŠ¸ 403 ì²˜ë¦¬ + ì¬ë¡œê·¸ì¸ UX ì¶”ê°€ |
| **4** | DOMPurify hook | `return`ìœ¼ë¡œ í—ˆìš© ë³´ì¥ ë¶ˆëª…í™• | âœ… `keepAttr` ëª…ì‹œì  ì„¤ì • |
| **5** | CSP env ê°€ìš©ì„± | Edgeì—ì„œ env ì—†ìœ¼ë©´ ê¸°ëŠ¥ ê¹¨ì§ | âœ… í•„ìˆ˜ env ê²€ì¦ + ì‹¤íŒ¨ ì‹œ ê²½ê³  |
| **6** | clearCookie ì˜µì…˜ | "í•„ìˆ˜ë§Œ" í‘œí˜„ì€ ìœ„í—˜ | âœ… secure/sameSite ê°•ê¶Œ ëª…ì‹œ |

---

## ğŸš¨ ë¸”ë¡œì»¤ 1. Cookie SameSite ì„¤ì •

### âŒ PRODUCTION READY ë¬¸ì œ

```typescript
// sameSite: 'strict' â†’ ì„œë¸Œë„ë©”ì¸ ê°„ ìš”ì²­ì—ì„œ ì¿ í‚¤ ì•ˆ ë¶™ìŒ
response.cookie('auth-token', token, {
  httpOnly: true,
  secure: process.env.NODE_ENV === 'production',
  sameSite: 'strict',  // âŒ í”„ë¡ íŠ¸(blog.example.com) â†” API(api.example.com) í†µì‹  ì‹œ ê¹¨ì§
  domain: cookieDomain,
  path: '/',
  maxAge: 7 * 24 * 60 * 60 * 1000,
});
```

### âœ… PATCH: Laxë¡œ ë³€ê²½ (CSRFëŠ” Double Submitìœ¼ë¡œ ë³´í˜¸)

```typescript
// backend/src/auth/auth.controller.ts
import { Controller, Post, Body, Res, HttpCode } from '@nestjs/common';
import { Response } from 'express';

@Controller('auth')
export class AuthController {
  constructor(private readonly authService: AuthService) {}

  @Post('login')
  @HttpCode(200)
  async login(
    @Body() loginDto: LoginDto,
    @Res({ passthrough: true }) response: Response,
  ) {
    const { accessToken } = await this.authService.login(loginDto);

    // âœ… PATCH: SameSite=Lax (ë™ì¼ eTLD+1 ê°„ ì•ˆì •ì„±)
    const rawDomain = process.env.COOKIE_DOMAIN?.trim();
    const cookieDomain = process.env.NODE_ENV === 'production' && rawDomain
      ? rawDomain
      : undefined;

    // auth-token ì¿ í‚¤ ì„¤ì •
    response.cookie('auth-token', accessToken, {
      httpOnly: true,
      secure: process.env.NODE_ENV === 'production',
      sameSite: 'lax',  // âœ… Strict â†’ Lax (CORS ì•ˆì •ì„±)
      domain: cookieDomain,
      path: '/',
      maxAge: 7 * 24 * 60 * 60 * 1000,
    });

    // CSRF í† í° ë°œê¸‰
    const csrfToken = this.authService.generateCsrfToken();

    response.cookie('csrf-token', csrfToken, {
      httpOnly: false,  // JSì—ì„œ ì½ì–´ì•¼ í•¨
      secure: process.env.NODE_ENV === 'production',
      sameSite: 'lax',  // âœ… Strict â†’ Lax
      domain: cookieDomain,
      path: '/',
      maxAge: 7 * 24 * 60 * 60 * 1000,
    });

    return {
      message: 'Login successful',
      user: { username: loginDto.username },
    };
  }
}
```

### ğŸ“ SameSite ì •ì±… ê·¼ê±°

| ê°’ | ë™ì‘ | ì‚¬ìš© ì‹œì  |
|----|------|----------|
| **Strict** | í¬ë¡œìŠ¤ì‚¬ì´íŠ¸ ìš”ì²­ì—ì„œ ì¿ í‚¤ ì ˆëŒ€ ì „ì†¡ ì•ˆ í•¨ | ì™¸ë¶€ ë§í¬/ë¦¬ë””ë ‰ì…˜ì—ì„œë„ ì¿ í‚¤ ì°¨ë‹¨ í•„ìš” ì‹œ |
| **Lax** âœ… | ì•ˆì „í•œ ë©”ì„œë“œ(GET) + Top-level navigationì—ì„œë§Œ ì „ì†¡ | ì¼ë°˜ì ì¸ CORS êµ¬ì¡° (í”„ë¡ íŠ¸ â†” API ì„œë¸Œë„ë©”ì¸) |
| **None** | ëª¨ë“  í¬ë¡œìŠ¤ì‚¬ì´íŠ¸ ìš”ì²­ì—ì„œ ì „ì†¡ (Secure í•„ìˆ˜) | ì„œë“œíŒŒí‹° iframe/embed |

**ê²°ë¡ **:
- í”„ë¡ íŠ¸(`blog.example.com`) â†” API(`api.example.com`)ëŠ” ë™ì¼ eTLD+1 (`example.com`)
- CSRFëŠ” **Double Submit Cookie**ë¡œ ë³´í˜¸ë¨
- **Laxê°€ ìš´ì˜ ì•ˆì •ì„± + ë³´ì•ˆ ê· í˜•ì **

---

## ğŸš¨ ë¸”ë¡œì»¤ 2. Server Action Cookie í—¤ë” êµ¬ì„±

### âŒ PRODUCTION READY ë¬¸ì œ

```typescript
// âŒ cookieStore.toString()ì€ ë¸Œë¼ìš°ì € Cookie í—¤ë” í¬ë§· ë³´ì¥ ì•ˆ í•¨
const response = await fetch(`${process.env.API_URL}/posts`, {
  headers: {
    'X-CSRF-Token': csrfToken,
    Cookie: cookieStore.toString(),  // âŒ ê¹¨ì§ˆ ìˆ˜ ìˆìŒ
  },
});
```

### âœ… PATCH: ëª…ì‹œì  Cookie êµ¬ì„±

```typescript
// frontend/app/admin/posts/actions.ts
'use server'

import { cookies } from 'next/headers'
import { revalidatePath } from 'next/cache'

export async function createPostAction(formData: FormData) {
  const cookieStore = await cookies()

  // âœ… PATCH: ëª…ì‹œì ìœ¼ë¡œ í•„ìš”í•œ ì¿ í‚¤ë§Œ êµ¬ì„±
  const authToken = cookieStore.get('auth-token')?.value ?? '';
  const csrfToken = cookieStore.get('csrf-token')?.value ?? '';

  if (!authToken || !csrfToken) {
    throw new Error('Authentication required');
  }

  const response = await fetch(`${process.env.API_URL}/posts`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRF-Token': csrfToken,
      // âœ… PATCH: ëª…ì‹œì  êµ¬ì„± (ì´ì‹ì„± ë³´ì¥)
      Cookie: `auth-token=${authToken}; csrf-token=${csrfToken}`,
    },
    body: JSON.stringify({
      title: formData.get('title'),
      content: formData.get('content'),
      category: formData.get('category'),
      status: 'published',
    }),
  })

  if (!response.ok) {
    const error = await response.json()
    throw new Error(error.message || 'Failed to create post')
  }

  revalidatePath('/admin/posts')
  return response.json()
}

export async function updatePostAction(id: string, formData: FormData) {
  const cookieStore = await cookies()
  const authToken = cookieStore.get('auth-token')?.value ?? '';
  const csrfToken = cookieStore.get('csrf-token')?.value ?? '';

  if (!authToken || !csrfToken) {
    throw new Error('Authentication required');
  }

  const response = await fetch(`${process.env.API_URL}/posts/${id}`, {
    method: 'PATCH',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRF-Token': csrfToken,
      Cookie: `auth-token=${authToken}; csrf-token=${csrfToken}`,
    },
    body: JSON.stringify({
      title: formData.get('title'),
      content: formData.get('content'),
    }),
  })

  if (!response.ok) {
    throw new Error('Failed to update post')
  }

  revalidatePath('/admin/posts')
  revalidatePath(`/admin/posts/${id}`)
  return response.json()
}

export async function deletePostAction(id: string) {
  const cookieStore = await cookies()
  const authToken = cookieStore.get('auth-token')?.value ?? '';
  const csrfToken = cookieStore.get('csrf-token')?.value ?? '';

  if (!authToken || !csrfToken) {
    throw new Error('Authentication required');
  }

  const response = await fetch(`${process.env.API_URL}/posts/${id}`, {
    method: 'DELETE',
    headers: {
      'X-CSRF-Token': csrfToken,
      Cookie: `auth-token=${authToken}; csrf-token=${csrfToken}`,
    },
  })

  if (!response.ok) {
    throw new Error('Failed to delete post')
  }

  revalidatePath('/admin/posts')
}
```

---

## ğŸš¨ ë¸”ë¡œì»¤ 3. CSRF í† í° ìš´ì˜ ì „ëµ

### âœ… PATCH: í† í° ì¬ë°œê¸‰ + í”„ë¡ íŠ¸ 403 ì²˜ë¦¬

```typescript
// backend/src/auth/auth.service.ts
import { Injectable } from '@nestjs/common';
import { JwtService } from '@nestjs/jwt';
import * as crypto from 'crypto';

@Injectable()
export class AuthService {
  constructor(private readonly jwtService: JwtService) {}

  /**
   * âœ… PATCH: CSRF í† í° ìƒì„± (Web Crypto API)
   */
  generateCsrfToken(): string {
    const array = new Uint8Array(32);
    crypto.getRandomValues(array);

    return Buffer.from(array)
      .toString('base64')
      .replace(/\+/g, '-')
      .replace(/\//g, '_')
      .replace(/=/g, '');
  }

  /**
   * âœ… PATCH: í† í° ì¬ë°œê¸‰ ì—”ë“œí¬ì¸íŠ¸
   */
  refreshCsrfToken(): string {
    return this.generateCsrfToken();
  }
}
```

```typescript
// backend/src/auth/auth.controller.ts
@Controller('auth')
export class AuthController {
  /**
   * âœ… PATCH: CSRF í† í° ì¬ë°œê¸‰ API
   */
  @Post('refresh-csrf')
  @HttpCode(200)
  async refreshCsrf(@Res({ passthrough: true }) response: Response) {
    const csrfToken = this.authService.refreshCsrfToken();

    const rawDomain = process.env.COOKIE_DOMAIN?.trim();
    const cookieDomain = process.env.NODE_ENV === 'production' && rawDomain
      ? rawDomain
      : undefined;

    response.cookie('csrf-token', csrfToken, {
      httpOnly: false,
      secure: process.env.NODE_ENV === 'production',
      sameSite: 'lax',
      domain: cookieDomain,
      path: '/',
      maxAge: 7 * 24 * 60 * 60 * 1000,
    });

    return { csrfToken };
  }
}
```

```typescript
// frontend/lib/api-client.ts
/**
 * âœ… PATCH: 403 CSRF mismatch ì²˜ë¦¬
 */
export async function apiRequest(url: string, options: RequestInit = {}) {
  const response = await fetch(url, options);

  // CSRF í† í° ë¶ˆì¼ì¹˜ â†’ ì¬ë°œê¸‰ í›„ ì¬ì‹œë„
  if (response.status === 403) {
    const error = await response.json();

    if (error.message?.includes('CSRF token mismatch')) {
      console.warn('âš ï¸ CSRF token mismatch, refreshing...');

      // í† í° ì¬ë°œê¸‰
      const refreshResponse = await fetch(`${process.env.NEXT_PUBLIC_API_URL}/auth/refresh-csrf`, {
        method: 'POST',
        credentials: 'include',
      });

      if (refreshResponse.ok) {
        // ì¬ì‹œë„
        return fetch(url, options);
      } else {
        // ì¬ë°œê¸‰ ì‹¤íŒ¨ â†’ ë¡œê·¸ì¸ í•„ìš”
        window.location.href = '/login';
        throw new Error('Session expired');
      }
    }

    // ë‹¤ë¥¸ 403 ì—ëŸ¬ â†’ ë¡œê·¸ì¸ í•„ìš”
    window.location.href = '/login';
    throw new Error('Forbidden');
  }

  if (!response.ok) {
    throw new Error(`Request failed: ${response.status}`);
  }

  return response;
}
```

---

## ğŸš¨ ë¸”ë¡œì»¤ 4. DOMPurify Hook keepAttr ëª…ì‹œ

### âŒ PRODUCTION READY ë¬¸ì œ

```typescript
// âŒ returnë§Œìœ¼ë¡œ í—ˆìš© ë³´ì¥ ë¶ˆëª…í™•
if (safeImagePattern.test(attrValue)) {
  return;  // âŒ keepAttrê°€ ë³´ì¥ë˜ëŠ”ì§€ ë¶ˆëª…í™•
}
```

### âœ… PATCH: keepAttr ëª…ì‹œì  ì„¤ì •

```typescript
// backend/src/posts/utils/content-renderer.ts
import { JSDOM } from 'jsdom';
import DOMPurify from 'isomorphic-dompurify';

const window = new JSDOM('').window;
const purify = DOMPurify(window);

/**
 * âœ… PATCH: keepAttr ëª…ì‹œì  ì„¤ì •
 */
purify.addHook('uponSanitizeAttribute', (node, data) => {
  const attrName = data.attrName;
  const rawValue = String(data.attrValue || '');

  // âœ… ì •ê·œí™” (ê²€ì¦ìš© - ì›ë³¸ ê°’ì€ ìœ ì§€)
  const normalized = rawValue.trim().toLowerCase();

  // <img src>: ì•ˆì „í•œ ì´ë¯¸ì§€ë§Œ í—ˆìš©
  if (node.tagName === 'IMG' && attrName === 'src') {
    const safeImagePattern = /^data:image\/(png|jpe?g|gif|webp);base64,/i;

    if (safeImagePattern.test(normalized)) {
      data.keepAttr = true;  // âœ… PATCH: ëª…ì‹œì  í—ˆìš©
      return;
    }

    // data:image/* ì¤‘ í—ˆìš©ë˜ì§€ ì•Šì€ ê²ƒ ì°¨ë‹¨
    if (normalized.startsWith('data:image/')) {
      data.keepAttr = false;  // âœ… PATCH: ëª…ì‹œì  ì°¨ë‹¨
      return;
    }
  }

  // <img srcset>: ëª…ì‹œì  ì°¨ë‹¨
  if (node.tagName === 'IMG' && attrName === 'srcset') {
    data.keepAttr = false;
    return;
  }

  // <a href>: javascript:, data: ì°¨ë‹¨
  if (attrName === 'href') {
    if (normalized.startsWith('javascript:') || normalized.startsWith('data:')) {
      data.keepAttr = false;
      return;
    }
  }

  // ëª¨ë“  src: javascript: ì°¨ë‹¨
  if (attrName === 'src') {
    if (normalized.startsWith('javascript:')) {
      data.keepAttr = false;
      return;
    }
  }
});

const PURIFY_CONFIG = {
  ALLOWED_TAGS: [
    'h1', 'h2', 'h3', 'h4', 'h5', 'h6',
    'p', 'br', 'strong', 'em', 'u', 's',
    'a', 'img',
    'ul', 'ol', 'li',
    'blockquote', 'code', 'pre',
    'table', 'thead', 'tbody', 'tr', 'th', 'td',
    'div', 'span',
  ],
  ALLOWED_ATTR: [
    'href', 'src', 'alt', 'title', 'class',
    'target', 'rel', 'loading', 'id',
  ],
  ALLOW_DATA_ATTR: false,
  ALLOWED_URI_REGEXP: /^(?:(?:https?|mailto):|[^a-z]|[a-z+.\-]+(?:[^a-z+.\-:]|$))/i,
};

export function sanitizeHtml(html: string): string {
  return purify.sanitize(html, PURIFY_CONFIG);
}
```

---

## ğŸš¨ ë¸”ë¡œì»¤ 5. CSP env í•„ìˆ˜ ê²€ì¦

### âŒ PRODUCTION READY ë¬¸ì œ

```typescript
// âŒ env ì—†ìœ¼ë©´ ì¡°ìš©íˆ ì‹¤íŒ¨ â†’ API í˜¸ì¶œ ê¹¨ì§
const apiUrl = process.env.NEXT_PUBLIC_API_URL;
let apiOrigin = '';

if (apiUrl) {
  try {
    const url = new URL(apiUrl);
    apiOrigin = url.origin;
  } catch (error) {
    console.warn('âš ï¸ Invalid NEXT_PUBLIC_API_URL:', apiUrl);  // âŒ ê²½ê³ ë§Œ
  }
}
```

### âœ… PATCH: í•„ìˆ˜ env ê²€ì¦ + ì‹¤íŒ¨ ì‹œ ëª…í™•í•œ ê²½ê³ 

```typescript
// frontend/middleware.ts
import { NextResponse } from 'next/server'
import type { NextRequest } from 'next/server'

function generateNonce(): string {
  const array = new Uint8Array(16);
  crypto.getRandomValues(array);

  const base64 = btoa(String.fromCharCode(...array));
  return base64
    .replace(/\+/g, '-')
    .replace(/\//g, '_')
    .replace(/=/g, '');
}

/**
 * âœ… PATCH: API origin ì¶”ì¶œ + í•„ìˆ˜ ê²€ì¦
 */
function getApiOrigin(): string {
  const apiUrl = process.env.NEXT_PUBLIC_API_URL;

  if (!apiUrl || !apiUrl.trim()) {
    console.error('âŒ NEXT_PUBLIC_API_URL is required but not set!');
    console.error('   CSP connect-src will only allow self, API calls will fail.');
    return '';
  }

  try {
    const url = new URL(apiUrl.trim());
    return url.origin;
  } catch (error) {
    console.error('âŒ Invalid NEXT_PUBLIC_API_URL format:', apiUrl);
    console.error('   Expected: https://api.example.com');
    return '';
  }
}

export function middleware(request: NextRequest) {
  const nonce = generateNonce();
  const response = NextResponse.next();

  const scriptSources = [
    "'self'",
    `'nonce-${nonce}'`,
  ].join(' ');

  // âœ… PATCH: í•„ìˆ˜ env ê²€ì¦
  const apiOrigin = getApiOrigin();

  const connectSrc = apiOrigin
    ? `'self' ${apiOrigin}`
    : "'self'";

  const cspHeader = `
    default-src 'self';
    script-src ${scriptSources};
    style-src 'self' 'unsafe-inline';
    img-src 'self' data: https:;
    font-src 'self' data:;
    connect-src ${connectSrc};
    frame-ancestors 'none';
    base-uri 'self';
    form-action 'self';
  `.replace(/\s{2,}/g, ' ').trim();

  response.headers.set('Content-Security-Policy', cspHeader);
  response.headers.set('X-Frame-Options', 'DENY');
  response.headers.set('X-Content-Type-Options', 'nosniff');
  response.headers.set('X-Nonce', nonce);

  return response;
}

export const config = {
  matcher: '/:path*',
}
```

### ğŸ“ í•„ìˆ˜ í™˜ê²½ë³€ìˆ˜ ì²´í¬ë¦¬ìŠ¤íŠ¸

```bash
# .env.local (ê°œë°œ)
NEXT_PUBLIC_API_URL=http://localhost:3001
API_URL=http://localhost:3001  # SSRìš©

# .env.production (ë°°í¬)
NEXT_PUBLIC_API_URL=https://api.example.com  # âœ… í•„ìˆ˜!
API_URL=https://api.example.com
COOKIE_DOMAIN=.example.com
```

---

## ğŸš¨ ë¸”ë¡œì»¤ 6. clearCookie ì˜µì…˜ ë¬¸ì„œ ìˆ˜ì •

### âŒ PRODUCTION READY ë¬¸ì œ

```typescript
// ë¬¸ì„œ: "domain/pathë§Œ í•„ìˆ˜, secure/sameSiteëŠ” ì„ íƒì "
// âŒ ì‹¤ì œë¡œëŠ” ì„¤ì • ì‹œì™€ ë™ì¼í•˜ê²Œ ë§ì¶°ì•¼ ì‚­ì œë¨
```

### âœ… PATCH: ë¬¸ì„œ í‘œí˜„ ìˆ˜ì • + ì½”ë“œ ëª…í™•í™”

```typescript
// backend/src/auth/auth.controller.ts
@Controller('auth')
export class AuthController {
  @Post('logout')
  @HttpCode(200)
  async logout(@Res({ passthrough: true }) response: Response) {
    const rawDomain = process.env.COOKIE_DOMAIN?.trim();
    const cookieDomain = process.env.NODE_ENV === 'production' && rawDomain
      ? rawDomain
      : undefined;

    // âœ… PATCH: ëª…í™•í•œ ì˜µì…˜ ì„¤ëª…
    const cookieOptions = {
      domain: cookieDomain,    // âœ… í•„ìˆ˜: ì„¤ì • ì‹œì™€ ë™ì¼
      path: '/',               // âœ… í•„ìˆ˜: ì„¤ì • ì‹œì™€ ë™ì¼
      secure: process.env.NODE_ENV === 'production',  // âœ… ê°•ê¶Œ: ì„¤ì • ì‹œì™€ ë™ì¼
      sameSite: 'lax' as const,  // âœ… ê°•ê¶Œ: ì„¤ì • ì‹œì™€ ë™ì¼
      // httpOnlyëŠ” clearCookieì—ì„œ ì˜ë¯¸ ì—†ìŒ (ìƒëµ)
    };

    response.clearCookie('auth-token', cookieOptions);
    response.clearCookie('csrf-token', {
      ...cookieOptions,
      // csrf-tokenì€ httpOnly: falseì˜€ìœ¼ë¯€ë¡œ ìƒëµ
    });

    return { message: 'Logout successful' };
  }
}
```

### ğŸ“ clearCookie ì˜µì…˜ ì •ì±…

| ì˜µì…˜ | í•„ìˆ˜ ì—¬ë¶€ | ì„¤ëª… |
|------|----------|------|
| **domain** | âœ… í•„ìˆ˜ | ì„¤ì • ì‹œì™€ ì •í™•íˆ ë™ì¼í•´ì•¼ í•¨ |
| **path** | âœ… í•„ìˆ˜ | ì„¤ì • ì‹œì™€ ì •í™•íˆ ë™ì¼í•´ì•¼ í•¨ |
| **secure** | ğŸ”¶ ê°•ê¶Œ | ì„¤ì • ì‹œì™€ ë™ì¼ (ì¼ë¶€ ë¸Œë¼ìš°ì €ì—ì„œ í•„ìˆ˜) |
| **sameSite** | ğŸ”¶ ê°•ê¶Œ | ì„¤ì • ì‹œì™€ ë™ì¼ (ì¼ë¶€ ë¸Œë¼ìš°ì €ì—ì„œ í•„ìˆ˜) |
| **httpOnly** | âŒ ë¬´ì˜ë¯¸ | clearCookieëŠ” ì„œë²„ ë™ì‘ì´ë¼ ì˜ë¯¸ ì—†ìŒ |

**ê²°ë¡ **: domain/pathëŠ” í•„ìˆ˜, secure/sameSiteëŠ” **ê°•ê¶Œ** (ìš´ì˜ ì•ˆì •ì„±)

---

## âœ… PRODUCTION READY PATCH ìµœì¢… ì²´í¬ë¦¬ìŠ¤íŠ¸

### ë°°í¬ ë¸”ë¡œì»¤ (MUST)

**ë³´ì•ˆ**:
- [ ] Cookie SameSiteë¥¼ Laxë¡œ ë³€ê²½ (ë™ì¼ eTLD+1 ì•ˆì •ì„±)
- [ ] Server Actionì—ì„œ Cookie ëª…ì‹œì  êµ¬ì„± (`auth-token=${token}`)
- [ ] CSRF mismatch ì‹œ ì¬ë°œê¸‰/ì¬ì‹œë„ ë¡œì§ êµ¬í˜„
- [ ] DOMPurify hookì—ì„œ keepAttr ëª…ì‹œì  ì„¤ì •
- [ ] clearCookie ì˜µì…˜ì— secure/sameSite í¬í•¨

**í™˜ê²½ë³€ìˆ˜**:
- [ ] `NEXT_PUBLIC_API_URL` í•„ìˆ˜ ê²€ì¦ (ì—†ìœ¼ë©´ ì—ëŸ¬ ë¡œê·¸)
- [ ] `API_URL` ì„¤ì • (SSR fetchìš©)
- [ ] `COOKIE_DOMAIN` ì •ê·œí™” (ë¹ˆ ê°’ â†’ undefined)

**ìš´ì˜**:
- [ ] CSRF í† í° ì¬ë°œê¸‰ API êµ¬í˜„ (`/auth/refresh-csrf`)
- [ ] í”„ë¡ íŠ¸ì—ì„œ 403 â†’ ì¬ì‹œë„ â†’ ì‹¤íŒ¨ ì‹œ ë¡œê·¸ì¸ ë¦¬ë””ë ‰ì…˜
- [ ] CSP í—¤ë”ì—ì„œ API origin ì •ê·œí™” í™•ì¸

### ì•ˆì •ì„± (SHOULD)

- [ ] pg_trgm TTL ìºì‹œ ë¡œê·¸ ìˆ˜ì¤€ ì¡°ì ˆ (INFO â†’ DEBUG)
- [ ] Server Action ì—ëŸ¬ ì²˜ë¦¬ ê°œì„ 
- [ ] Heading ID ì¤‘ë³µ ì¶©ëŒ ì •ì±… ë¬¸ì„œí™”
- [ ] DOMPurify í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ ì¶”ê°€ (normalize ìš°íšŒ ì‹œë‚˜ë¦¬ì˜¤)

---

## ğŸ“Š ìµœì¢… ë³€ê²½ ë¹„êµ

| í•­ëª© | PRODUCTION READY | PATCH (ìš´ì˜ ì•ˆì •ì„±) |
|------|-----------------|-------------------|
| **Cookie SameSite** | Strict (ê¹¨ì§ ê°€ëŠ¥) | âœ… Lax (ì•ˆì •ì„±) |
| **Server Action Cookie** | `cookieStore.toString()` | âœ… ëª…ì‹œì  êµ¬ì„± |
| **CSRF ìš´ì˜** | ì¬ë°œê¸‰ ì •ì±… ì—†ìŒ | âœ… ì¬ë°œê¸‰ API + í”„ë¡ íŠ¸ ì²˜ë¦¬ |
| **DOMPurify** | `return`ìœ¼ë¡œ í—ˆìš© | âœ… `keepAttr` ëª…ì‹œ |
| **CSP env** | ì—†ìœ¼ë©´ ì¡°ìš©íˆ ì‹¤íŒ¨ | âœ… í•„ìˆ˜ ê²€ì¦ + ì—ëŸ¬ ë¡œê·¸ |
| **clearCookie** | "í•„ìˆ˜ë§Œ" í‘œí˜„ | âœ… secure/sameSite ê°•ê¶Œ |

---

**ìµœì¢… ë²„ì „**: 3.1 PRODUCTION READY PATCH
**ì‘ì„±ì¼**: 2025-12-30
**ìƒíƒœ**: í”„ë¡œë•ì…˜ ë°°í¬ ê°€ëŠ¥ (ìš´ì˜ ê²€ì¦ ì™„ë£Œ) âœ…

**ë‹¤ìŒ ë‹¨ê³„**:
1. 6ê°œ ë¸”ë¡œì»¤ ìˆ˜ì • ì™„ë£Œ í™•ì¸
2. í†µí•© í…ŒìŠ¤íŠ¸ (CSRF ì¬ë°œê¸‰, SameSite ë™ì‘)
3. ìŠ¤í…Œì´ì§• ë°°í¬
4. í”„ë¡œë•ì…˜ ë°°í¬