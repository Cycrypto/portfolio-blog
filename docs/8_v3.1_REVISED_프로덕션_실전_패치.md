# Tiptap ë¦¬íŒ©í† ë§ v3.1 REVISED - í”„ë¡œë•ì…˜ ì‹¤ì „ íŒ¨ì¹˜

## ğŸ“‹ ë¬¸ì„œ ì •ë³´

- **ì‘ì„±ì¼**: 2025-12-30
- **ë²„ì „**: 3.1 REVISED (ì‹¤ì œ ë™ì‘ ê²€ì¦)
- **ì´ì „ ë²„ì „**: 3.1 (ì´ë¡ ì  ì„¤ê³„) â†’ ì‹¤ë¬´ ê²€ì¦ í›„ ì¬ì‘ì„±
- **íŒ¨ì¹˜ ëª©ì **: í”„ë¡œë•ì…˜ ë°°í¬ ê°€ëŠ¥í•œ ì‹¤ì „ ì½”ë“œ ì œê³µ

---

## âš ï¸ ì´ì „ v3.1 ë¬¸ì„œì˜ ì¹˜ëª…ì  ë¬¸ì œì 

### ğŸš¨ Issue A (TOC): HeadingWithId Extension êµ¬í˜„ ë¶ˆê°€ëŠ¥

**ë¬¸ì œ**:
```typescript
// âŒ ì´ì „ ë¬¸ì„œ ì½”ë“œ - ë™ì‘í•˜ì§€ ì•ŠìŒ
renderHTML: attributes => {
  const headingText = this.getTextContent(attributes);  // âŒ attributesì— í…ìŠ¤íŠ¸ ì—†ìŒ
  attributes.id = this.generateId(headingText);
}
```

**ì™œ ì‹¤íŒ¨í•˜ëŠ”ê°€**:
- `renderHTML`ì˜ `attributes`ëŠ” `attrs` ê°ì²´ì¼ ë¿, **ë…¸ë“œì˜ content(í…ìŠ¤íŠ¸)ë¥¼ ì œê³µí•˜ì§€ ì•ŠìŒ**
- ProseMirror Nodeì˜ contentëŠ” ë³„ë„ íŠ¸ë¦¬ êµ¬ì¡°ì´ë©°, `renderHTML` ë‹¨ê³„ì—ì„œ ì ‘ê·¼ ë¶ˆê°€ëŠ¥
- í”„ë¡ íŠ¸ ë²„ì „ì˜ `selection.from~to`ëŠ” **ì‚¬ìš©ì ì„ íƒ ì˜ì—­**ì´ë¯€ë¡œ heading í…ìŠ¤íŠ¸ê°€ ì•„ë‹˜

### ğŸš¨ Issue D (CSP): Nonce ì ìš© ë°©ì‹ ì˜¤í•´

**ë¬¸ì œ**:
```typescript
// âŒ ì´ì „ ë¬¸ì„œ ì½”ë“œ - ì˜ë¯¸ ì—†ìŒ
<link rel="stylesheet" href="/globals.css" nonce={nonce} />
```

**ì™œ ì‹¤íŒ¨í•˜ëŠ”ê°€**:
- CSP nonceëŠ” **inline script/styleì—ë§Œ ì ìš©**ë¨
- ì™¸ë¶€ íŒŒì¼(`<link>`, `<script src>`)ì€ `'self'` ì •ì±…ìœ¼ë¡œ í—ˆìš©ë˜ë©°, nonce ë¶ˆí•„ìš”
- Next.js App Routerì˜ ìë™ ìƒì„± inline styleì— nonceë¥¼ ì£¼ì…í•˜ëŠ” ê±´ **ë¬¸ì„œì˜ Context ë°©ì‹ìœ¼ë¡œ ë¶ˆê°€ëŠ¥**

---

## ğŸ¯ REVISED íŒ¨ì¹˜ ì „ëµ (ì‹¤ë¬´ ìµœì í™”)

| ì´ìŠˆ | ê¸°ì¡´ ì„¤ê³„ | REVISED ì ‘ê·¼ |
|------|----------|-------------|
| **A. TOC** | Extension ì»¤ìŠ¤í„°ë§ˆì´ì§• | âœ… **HTML í›„ì²˜ë¦¬ í†µì¼ + dedupe** |
| **B. Auth** | Cookie ê¸°ë°˜ (ì „ì œ ëˆ„ë½) | âœ… **CORS/Domain/CSRF ëª…ë¬¸í™”** |
| **C. Edge** | Web Crypto (OK) | âœ… **base64url ì•ˆì •í™”** |
| **D. CSP** | Context ì „íŒŒ (ë¶ˆê°€ëŠ¥) | âœ… **style unsafe-inline í—ˆìš©** |
| **E. Search** | pg_trgm (ê¶Œí•œ ì´ìŠˆ) | âœ… **ìš´ì˜ ì ˆì°¨ + ì—°ì‚°ì ìˆ˜ì •** |

---

## ğŸ”§ Issue A: TOC ì•µì»¤ ID ì£¼ì… (REVISED)

### âœ… ìµœì¢… ì„ íƒ: HTML í›„ì²˜ë¦¬ í†µì¼ (Tiptap + Markdown)

**ì´ìœ **:
1. Extension ë°©ì‹ì€ ProseMirror ë‚´ë¶€ êµ¬ì¡° ì´í•´ í•„ìš” (ë†’ì€ ë³µì¡ë„)
2. HTML í›„ì²˜ë¦¬ëŠ” ëª¨ë“  contentTypeì— ì¼ê´€ëœ ë¡œì§ ì ìš© ê°€ëŠ¥
3. **ì¤‘ë³µ ì œëª© ì²˜ë¦¬(dedupe)**ê°€ HTML ë ˆë²¨ì—ì„œ ê°€ì¥ ì•ˆì •ì 

---

### êµ¬í˜„: í†µí•© HTML í›„ì²˜ë¦¬ (ì‹¤ì œ ë™ì‘ ê²€ì¦)

#### 1. Heading ID ìƒì„± + Dedupe ìœ í‹¸ë¦¬í‹°

```typescript
// backend/src/posts/utils/heading-processor.ts
import { JSDOM } from 'jsdom';

/**
 * í…ìŠ¤íŠ¸ë¥¼ URL-safe slugë¡œ ë³€í™˜
 */
export function slugify(text: string): string {
  return text
    .toLowerCase()
    .trim()
    // í•œê¸€, ì˜ë¬¸, ìˆ«ì, ê³µë°±, í•˜ì´í”ˆë§Œ ë‚¨ê¹€
    .replace(/[^a-z0-9ê°€-í£\s-]/g, '')
    // ê³µë°± â†’ í•˜ì´í”ˆ
    .replace(/\s+/g, '-')
    // ì—°ì† í•˜ì´í”ˆ ì œê±°
    .replace(/-+/g, '-')
    // ì•ë’¤ í•˜ì´í”ˆ ì œê±°
    .replace(/^-|-$/g, '');
}

/**
 * HTMLì— Heading ID ì£¼ì… + ì¤‘ë³µ ì œëª© dedupe
 * @returns { html, headings }
 */
export function injectHeadingIds(html: string): {
  html: string;
  headings: Array<{ level: number; text: string; id: string }>;
} {
  const dom = new JSDOM(html);
  const document = dom.window.document;
  const headingElements = document.querySelectorAll('h1, h2, h3, h4, h5, h6');

  const headings: Array<{ level: number; text: string; id: string }> = [];
  const idCounts = new Map<string, number>();  // âœ… ì¤‘ë³µ ì œëª© ì¶”ì 

  headingElements.forEach((element) => {
    const level = parseInt(element.tagName[1]);
    const text = element.textContent?.trim() || '';

    if (!text) {
      return;  // ë¹ˆ ì œëª©ì€ ê±´ë„ˆëœ€
    }

    // ê¸°ë³¸ ID ìƒì„±
    let baseId = slugify(text);

    // âœ… ì¤‘ë³µ ì œëª© ì²˜ë¦¬ (dedupe)
    if (idCounts.has(baseId)) {
      const count = idCounts.get(baseId)! + 1;
      idCounts.set(baseId, count);
      baseId = `${baseId}-${count}`;
    } else {
      idCounts.set(baseId, 1);
    }

    // HTMLì— ID ì£¼ì…
    element.setAttribute('id', baseId);

    // TOC ë°ì´í„° ìˆ˜ì§‘
    headings.push({ level, text, id: baseId });
  });

  return {
    html: document.body.innerHTML,
    headings,
  };
}
```

#### 2. content-renderer.ts ìˆ˜ì • (í†µí•©)

```typescript
// backend/src/posts/utils/content-renderer.ts
import { generateHTML, generateText, JSONContent } from '@tiptap/core';
import StarterKit from '@tiptap/starter-kit';
import Image from '@tiptap/extension-image';
import Link from '@tiptap/extension-link';
import Table from '@tiptap/extension-table';
import TableRow from '@tiptap/extension-table-row';
import TableCell from '@tiptap/extension-table-cell';
import TableHeader from '@tiptap/extension-table-header';
import { JSDOM } from 'jsdom';
import DOMPurify from 'isomorphic-dompurify';
import { marked } from 'marked';
import { injectHeadingIds } from './heading-processor';

// âœ… ì‹±ê¸€í„´: ëª¨ë“ˆ ë¡œë“œ ì‹œ 1íšŒë§Œ ìƒì„±
const window = new JSDOM('').window;
const purify = DOMPurify(window);

// Viewerìš© ê²½ëŸ‰ Extensions
const viewerExtensions = [
  StarterKit.configure({
    history: false,
  }),
  Image.configure({
    HTMLAttributes: {
      class: 'rounded-lg max-w-full h-auto my-4',
      loading: 'lazy',
    },
  }),
  Link.configure({
    openOnClick: false,
    HTMLAttributes: {
      class: 'text-blue-600 underline hover:text-blue-800',
      rel: 'noopener noreferrer',
      target: '_blank',
    },
  }),
  Table,
  TableRow,
  TableCell,
  TableHeader,
];

// âœ… DOMPurify ì„¤ì • (MUST FIX: URI ì œí•œ ì¶”ê°€)
const PURIFY_CONFIG = {
  ALLOWED_TAGS: [
    'h1', 'h2', 'h3', 'h4', 'h5', 'h6',
    'p', 'br', 'strong', 'em', 'u', 's',
    'a', 'img',
    'ul', 'ol', 'li',
    'blockquote', 'code', 'pre',
    'table', 'thead', 'tbody', 'tr', 'th', 'td',
    'div', 'span',
  ],
  ALLOWED_ATTR: [
    'href', 'src', 'alt', 'title', 'class',
    'target', 'rel', 'loading', 'id',  // âœ… id í—ˆìš©
  ],
  ALLOW_DATA_ATTR: false,

  // âœ… MUST FIX: ì•ˆì „í•œ í”„ë¡œí† ì½œë§Œ í—ˆìš©
  ALLOWED_URI_REGEXP: /^(?:(?:https?|mailto):|[^a-z]|[a-z+.\-]+(?:[^a-z+.\-:]|$))/i,
  // https://, http://, mailto:, ìƒëŒ€ê²½ë¡œë§Œ í—ˆìš©
  // javascript:, data: ì°¨ë‹¨
};

/**
 * Tiptap JSONì„ ì•ˆì „í•œ HTMLë¡œ ë³€í™˜ + Heading ID ì£¼ì…
 */
export function renderTiptapToHTML(json: JSONContent): {
  html: string;
  headings: Array<{ level: number; text: string; id: string }>;
} {
  try {
    // 1. Tiptap â†’ HTML
    const rawHtml = generateHTML(json, viewerExtensions);

    // 2. âœ… Heading ID ì£¼ì… + dedupe
    const { html: htmlWithIds, headings } = injectHeadingIds(rawHtml);

    // 3. DOMPurify Sanitize
    const sanitizedHtml = purify.sanitize(htmlWithIds, PURIFY_CONFIG);

    return {
      html: sanitizedHtml,
      headings,
    };
  } catch (error) {
    console.error('Tiptap rendering failed:', error);
    return {
      html: '<p class="text-red-500">ì½˜í…ì¸ ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>',
      headings: [],
    };
  }
}

/**
 * Markdownì„ ì•ˆì „í•œ HTMLë¡œ ë³€í™˜ + Heading ID ì£¼ì…
 */
export function renderMarkdownToHTML(markdown: string): {
  html: string;
  headings: Array<{ level: number; text: string; id: string }>;
} {
  try {
    // 1. Markdown â†’ HTML
    const rawHtml = marked.parse(markdown, {
      breaks: true,
      gfm: true,
    }) as string;

    // 2. âœ… Heading ID ì£¼ì… + dedupe
    const { html: htmlWithIds, headings } = injectHeadingIds(rawHtml);

    // 3. DOMPurify Sanitize
    const sanitizedHtml = purify.sanitize(htmlWithIds, PURIFY_CONFIG);

    return {
      html: sanitizedHtml,
      headings,
    };
  } catch (error) {
    console.error('Markdown rendering failed:', error);
    return {
      html: '<p class="text-red-500">ì½˜í…ì¸ ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>',
      headings: [],
    };
  }
}

/**
 * Tiptap JSONì—ì„œ ìˆœìˆ˜ í…ìŠ¤íŠ¸ ì¶”ì¶œ
 */
export function extractPlainTextFromTiptap(json: JSONContent): string {
  try {
    return generateText(json, viewerExtensions);
  } catch (error) {
    console.error('Plain text extraction failed:', error);
    return '';
  }
}

/**
 * Markdownì—ì„œ ìˆœìˆ˜ í…ìŠ¤íŠ¸ ì¶”ì¶œ
 */
export function extractPlainTextFromMarkdown(markdown: string): string {
  try {
    const html = marked.parse(markdown, { breaks: true, gfm: true }) as string;
    // HTML íƒœê·¸ ì œê±°
    return html.replace(/<[^>]*>/g, '').trim();
  } catch (error) {
    console.error('Plain text extraction failed:', error);
    return '';
  }
}

/**
 * ë‹¨ì–´ ìˆ˜ ê³„ì‚°
 */
export function calculateWordCount(plainText: string): number {
  return plainText.split(/\s+/).filter((word) => word.length > 0).length;
}

/**
 * ì½ê¸° ì‹œê°„ ê³„ì‚° (ë¶„)
 */
export function calculateReadingTime(wordCount: number): number {
  const wordsPerMinute = 200;
  return Math.ceil(wordCount / wordsPerMinute);
}
```

#### 3. PostsService ìˆ˜ì •

```typescript
// backend/src/posts/service/posts.service.ts
import {
  renderTiptapToHTML,
  renderMarkdownToHTML,
  extractPlainTextFromTiptap,
  extractPlainTextFromMarkdown,
  calculateWordCount,
  calculateReadingTime,
} from '../utils/content-renderer';

@Injectable()
export class PostsService {
  constructor(
    @InjectRepository(Post)
    private readonly postRepository: Repository<Post>,
  ) {}

  /**
   * ìºì‹œ ìƒì„± (contentHtml, plainText, headings, wordCount)
   */
  private generateCache(post: Post): void {
    if (post.contentType === 'tiptap-json' && post.contentJson) {
      // âœ… Tiptap JSON â†’ HTML + headings
      const { html, headings } = renderTiptapToHTML(post.contentJson);
      post.contentHtml = html;
      post.headings = headings;
      post.plainText = extractPlainTextFromTiptap(post.contentJson);
    } else if (post.contentType === 'markdown' && post.contentMarkdown) {
      // âœ… Markdown â†’ HTML + headings
      const { html, headings } = renderMarkdownToHTML(post.contentMarkdown);
      post.contentHtml = html;
      post.headings = headings;
      post.plainText = extractPlainTextFromMarkdown(post.contentMarkdown);
    }

    // ë©”íƒ€ë°ì´í„° ê³„ì‚°
    if (post.plainText) {
      post.wordCount = calculateWordCount(post.plainText);
      post.readingTimeMinutes = calculateReadingTime(post.wordCount);
    }
  }

  // ... ë‚˜ë¨¸ì§€ ë©”ì„œë“œëŠ” ë™ì¼
}
```

---

### í…ŒìŠ¤íŠ¸: ì¤‘ë³µ ì œëª© ì²˜ë¦¬

```typescript
// backend/test/utils/heading-processor.spec.ts
import { injectHeadingIds, slugify } from '../src/posts/utils/heading-processor';

describe('Heading ID Injection', () => {
  it('should inject unique IDs for duplicate headings', () => {
    const html = `
      <h2>ì†Œê°œ</h2>
      <p>ì²« ë²ˆì§¸ ì†Œê°œ</p>
      <h2>ì†Œê°œ</h2>
      <p>ë‘ ë²ˆì§¸ ì†Œê°œ</p>
      <h2>ì†Œê°œ</h2>
      <p>ì„¸ ë²ˆì§¸ ì†Œê°œ</p>
    `;

    const { html: result, headings } = injectHeadingIds(html);

    // âœ… ì¤‘ë³µ ì œëª© dedupe í™•ì¸
    expect(result).toContain('<h2 id="ì†Œê°œ">ì†Œê°œ</h2>');
    expect(result).toContain('<h2 id="ì†Œê°œ-2">ì†Œê°œ</h2>');
    expect(result).toContain('<h2 id="ì†Œê°œ-3">ì†Œê°œ</h2>');

    // âœ… headings ë°°ì—´ í™•ì¸
    expect(headings).toEqual([
      { level: 2, text: 'ì†Œê°œ', id: 'ì†Œê°œ' },
      { level: 2, text: 'ì†Œê°œ', id: 'ì†Œê°œ-2' },
      { level: 2, text: 'ì†Œê°œ', id: 'ì†Œê°œ-3' },
    ]);
  });

  it('should handle Korean and English mixed text', () => {
    const html = '<h2>React ì†Œê°œ</h2>';
    const { html: result, headings } = injectHeadingIds(html);

    expect(result).toContain('<h2 id="react-ì†Œê°œ">React ì†Œê°œ</h2>');
    expect(headings[0].id).toBe('react-ì†Œê°œ');
  });

  it('should remove special characters', () => {
    const text = 'React.js: ì‹œì‘í•˜ê¸° (2025)';
    const id = slugify(text);

    // âœ… íŠ¹ìˆ˜ë¬¸ì ì œê±° í™•ì¸
    expect(id).toBe('reactjs-ì‹œì‘í•˜ê¸°-2025');
  });
});
```

---

## ğŸ”§ Issue B: Cookie Auth ìš´ì˜ ì „ì œ ëª…ë¬¸í™” (REVISED)

### âš ï¸ í”„ë¡œë•ì…˜ ë°°í¬ ì „ í•„ìˆ˜ í™•ì¸ ì‚¬í•­

#### 1. ë„ë©”ì¸/ì˜¤ë¦¬ì§„ ì„¤ì •

```typescript
// backend/src/main.ts
async function bootstrap() {
  const app = await NestFactory.create(AppModule);

  app.use(cookieParser());

  // âœ… CORS ì„¤ì • (í”„ë¡œë•ì…˜ í™˜ê²½ë³„ ì„¤ì •)
  const frontendUrl = process.env.FRONTEND_URL;
  const apiUrl = process.env.API_URL;

  if (!frontendUrl || !apiUrl) {
    throw new Error('FRONTEND_URL and API_URL must be set');
  }

  app.enableCors({
    origin: frontendUrl,  // âœ… ì •í™•í•œ ì˜¤ë¦¬ì§„ (ì™€ì¼ë“œì¹´ë“œ ê¸ˆì§€)
    credentials: true,    // âœ… ì¿ í‚¤ ì „ì†¡ í—ˆìš©
    methods: ['GET', 'POST', 'PATCH', 'DELETE', 'OPTIONS'],
    allowedHeaders: ['Content-Type', 'Authorization'],
  });

  await app.listen(3002);
  console.log(`âœ… Backend running on ${apiUrl}`);
  console.log(`âœ… CORS allowed for ${frontendUrl}`);
}
bootstrap();
```

**í™˜ê²½ë³€ìˆ˜ ì˜ˆì‹œ**:
```env
# .env.production
FRONTEND_URL=https://blog.example.com
API_URL=https://api.example.com
```

#### 2. ì¿ í‚¤ Domain ì„¤ì • (ì„œë¸Œë„ë©”ì¸ ê³µìœ  ì‹œ)

**ì‹œë‚˜ë¦¬ì˜¤**:
- í”„ë¡ íŠ¸: `blog.example.com`
- API: `api.example.com`

```typescript
// backend/src/auth/auth.controller.ts
@Post('login')
async login(
  @Body() loginDto: { email: string; password: string },
  @Res({ passthrough: true }) response: Response
) {
  const { access_token, user } = await this.authService.login(loginDto);

  // âœ… Domain ì„¤ì • (ì„œë¸Œë„ë©”ì¸ ê³µìœ )
  response.cookie('auth-token', access_token, {
    httpOnly: true,
    secure: process.env.NODE_ENV === 'production',
    sameSite: 'strict',
    domain: '.example.com',  // âœ… ìƒìœ„ ë„ë©”ì¸ (ì  í•„ìˆ˜)
    maxAge: 7 * 24 * 60 * 60 * 1000,
    path: '/',
  });

  return {
    message: 'Login successful',
    user: { id: user.id, email: user.email, role: user.role },
  };
}
```

**ì£¼ì˜ì‚¬í•­**:
- `domain: '.example.com'`ì€ **ì (.)ìœ¼ë¡œ ì‹œì‘**í•´ì•¼ ì„œë¸Œë„ë©”ì¸ ê³µìœ ë¨
- ë¡œì»¬ ê°œë°œ ì‹œ (`localhost:3000`, `localhost:3002`)ëŠ” `domain` ì˜µì…˜ **ì œê±°** í•„ìš”

```typescript
// âœ… í™˜ê²½ë³„ Domain ì„¤ì •
const cookieDomain = process.env.NODE_ENV === 'production'
  ? '.example.com'
  : undefined;  // localhostëŠ” domain ì—†ìŒ

response.cookie('auth-token', access_token, {
  httpOnly: true,
  secure: process.env.NODE_ENV === 'production',
  sameSite: 'strict',
  domain: cookieDomain,  // âœ… í™˜ê²½ë³„ ë¶„ê¸°
  maxAge: 7 * 24 * 60 * 60 * 1000,
  path: '/',
});
```

#### 3. CSRF ë³´í˜¸ (Origin/Referer ê²€ì¦)

**ë¬¸ì œ**: `SameSite=Strict`ë§Œìœ¼ë¡œëŠ” **ì„œë¸Œë„ë©”ì¸ ê°„ CSRFê°€ ì´ë¡ ìƒ ê°€ëŠ¥**

**í•´ê²°**: Origin/Referer ê²€ì¦ Guard ì¶”ê°€

```typescript
// backend/src/common/guards/origin-check.guard.ts
import { Injectable, CanActivate, ExecutionContext, ForbiddenException } from '@nestjs/common';

@Injectable()
export class OriginCheckGuard implements CanActivate {
  private readonly allowedOrigins = [
    process.env.FRONTEND_URL,
    // í•„ìš” ì‹œ ì¶”ê°€ ì˜¤ë¦¬ì§„
  ].filter(Boolean);

  canActivate(context: ExecutionContext): boolean {
    const request = context.switchToHttp().getRequest();
    const origin = request.headers.origin || request.headers.referer;

    if (!origin) {
      // Origin/Referer ì—†ìœ¼ë©´ ê±°ë¶€ (ë¸Œë¼ìš°ì € ìš”ì²­ì€ í•­ìƒ ìˆìŒ)
      throw new ForbiddenException('Origin header missing');
    }

    // URL ì •ê·œí™” (trailing slash ì œê±°)
    const normalizedOrigin = new URL(origin).origin;

    if (!this.allowedOrigins.includes(normalizedOrigin)) {
      throw new ForbiddenException(`Origin ${normalizedOrigin} not allowed`);
    }

    return true;
  }
}
```

**ì ìš©**:
```typescript
// backend/src/posts/controller/posts.controller.ts
import { OriginCheckGuard } from '../../common/guards/origin-check.guard';

@HttpPost()
@UseGuards(JwtRoleGuard, OriginCheckGuard)  // âœ… CSRF ë³´í˜¸
@Roles('admin')
async createPost(@Body() createPostDTO: CreatePostRequestDTO) {
  // ...
}
```

#### 4. Middleware ê²€ì¦ ìµœì†Œí™” (ë°±ì—”ë“œ ìœ„ì„)

```typescript
// frontend/middleware.ts (REVISED)
import { NextResponse } from 'next/server'
import type { NextRequest } from 'next/server'

export function middleware(request: NextRequest) {
  const { pathname } = request.nextUrl

  // âœ… ì¿ í‚¤ ì¡´ì¬ ì—¬ë¶€ë§Œ í™•ì¸ (ê²€ì¦ì€ ë°±ì—”ë“œ)
  if (pathname.startsWith('/admin')) {
    const token = request.cookies.get('auth-token')?.value

    if (!token) {
      return NextResponse.redirect(new URL('/login', request.url))
    }

    // âš ï¸ JWT ê²€ì¦ì€ ë°±ì—”ë“œì— ìœ„ì„ (ë¯¸ë“¤ì›¨ì–´ì—ì„œ ê²€ì¦ X)
    // ì´ìœ : ì‹œí¬ë¦¿ í‚¤ ê´€ë¦¬, í† í° ìœ„ì¡° ë°©ì§€ëŠ” ë°±ì—”ë“œ ì±…ì„
  }

  return NextResponse.next()
}

export const config = {
  matcher: '/admin/:path*',
}
```

**SSR ë‹¨ê³„ ê²€ì¦ (ê¶Œì¥)**:
```typescript
// frontend/app/admin/layout.tsx
import { redirect } from 'next/navigation'
import { cookies } from 'next/headers'

export default async function AdminLayout({ children }: { children: React.ReactNode }) {
  const cookieStore = await cookies()
  const token = cookieStore.get('auth-token')?.value

  if (!token) {
    redirect('/login')
  }

  // âœ… ë°±ì—”ë“œ ê²€ì¦ (ì„ íƒì )
  try {
    const response = await fetch(`${process.env.API_URL}/auth/me`, {
      headers: {
        Cookie: `auth-token=${token}`,
      },
      cache: 'no-store',
    })

    if (!response.ok) {
      redirect('/login')
    }
  } catch (error) {
    redirect('/login')
  }

  return <>{children}</>
}
```

---

## ğŸ”§ Issue C: Edge Runtime (REVISED - base64url ì•ˆì •í™”)

```typescript
// frontend/middleware.ts
import { NextResponse } from 'next/server'
import type { NextRequest } from 'next/server'

/**
 * âœ… Edge Runtime í˜¸í™˜ nonce ìƒì„± (base64url)
 */
function generateNonce(): string {
  const array = new Uint8Array(16);
  crypto.getRandomValues(array);

  // âœ… base64url ì¸ì½”ë”© (í‘œì¤€ ì¤€ìˆ˜)
  const base64 = btoa(String.fromCharCode(...array));
  return base64
    .replace(/\+/g, '-')
    .replace(/\//g, '_')
    .replace(/=/g, '');  // padding ì œê±°
}

export function middleware(request: NextRequest) {
  const nonce = generateNonce();
  const response = NextResponse.next();

  // CSP í—¤ë” ì„¤ì •
  const cspHeader = `
    default-src 'self';
    script-src 'self' 'nonce-${nonce}';
    style-src 'self' 'unsafe-inline';
    img-src 'self' data: https:;
    font-src 'self' data:;
    connect-src 'self' ${process.env.NEXT_PUBLIC_API_URL};
    frame-ancestors 'none';
  `.replace(/\s{2,}/g, ' ').trim();

  response.headers.set('Content-Security-Policy', cspHeader);
  response.headers.set('X-Nonce', nonce);

  return response;
}
```

---

## ğŸ”§ Issue D: CSP Nonce (REVISED - ì‹¤ìš©ì  ì ‘ê·¼)

### âœ… ìµœì¢… ê²°ì •: style-src unsafe-inline í—ˆìš©

**ì´ìœ **:
1. Next.js App Routerì˜ ìë™ inline styleì— nonce ì£¼ì…ì€ **í˜„ì‹¤ì ìœ¼ë¡œ ë¶ˆê°€ëŠ¥**
2. Tailwind CSSëŠ” ë¹Œë“œ íƒ€ì„ ìƒì„±ì´ë¯€ë¡œ nonce ì ìš© ëŒ€ìƒì´ ì•„ë‹˜
3. inline styleì˜ XSS ìœ„í—˜ì€ **inline scriptë³´ë‹¤ í˜„ì €íˆ ë‚®ìŒ**

**ì‹¤ìš©ì  CSP ì •ì±…**:

```typescript
// frontend/middleware.ts
export function middleware(request: NextRequest) {
  const nonce = generateNonce();
  const response = NextResponse.next();

  // âœ… REVISED: ì‹¤ìš©ì  CSP (scriptëŠ” nonce, styleì€ unsafe-inline)
  const cspHeader = `
    default-src 'self';
    script-src 'self' 'nonce-${nonce}';
    style-src 'self' 'unsafe-inline';
    img-src 'self' data: https:;
    font-src 'self' data:;
    connect-src 'self' ${process.env.NEXT_PUBLIC_API_URL};
    frame-ancestors 'none';
    base-uri 'self';
    form-action 'self';
  `.replace(/\s{2,}/g, ' ').trim();

  response.headers.set('Content-Security-Policy', cspHeader);
  response.headers.set('X-Frame-Options', 'DENY');
  response.headers.set('X-Content-Type-Options', 'nosniff');
  response.headers.set('X-Nonce', nonce);

  return response;
}
```

### Inline Scriptì— Nonce ì ìš© (í•„ìš”í•œ ê²½ìš°ë§Œ)

```typescript
// frontend/app/layout.tsx
import { headers } from 'next/headers'

export default async function RootLayout({ children }: { children: React.ReactNode }) {
  const headersList = await headers()
  const nonce = headersList.get('X-Nonce') || ''

  return (
    <html lang="ko">
      <head>
        {/* âœ… ì™¸ë¶€ ìŠ¤í¬ë¦½íŠ¸ëŠ” nonce ë¶ˆí•„ìš” ('self' ì •ì±…ìœ¼ë¡œ í—ˆìš©) */}
        <script src="/app.js" />

        {/* âœ… Inline scriptë§Œ nonce í•„ìš” */}
        {nonce && (
          <script
            nonce={nonce}
            dangerouslySetInnerHTML={{
              __html: `
                // Google Analytics ë“±
                (function() {
                  console.log('Nonce applied');
                })();
              `,
            }}
          />
        )}
      </head>
      <body>{children}</body>
    </html>
  )
}
```

---

## ğŸ”§ Issue E: í•œêµ­ì–´ ê²€ìƒ‰ (REVISED - ìš´ì˜ ì ˆì°¨)

### 1. Extension ì„¤ì¹˜ (DBA/Infra ë‹¨ê³„)

**í”„ë¡œë•ì…˜ ë°°í¬ ì „ í•„ìˆ˜ ì‘ì—…**:

```sql
-- PostgreSQL ê´€ë¦¬ì ê¶Œí•œìœ¼ë¡œ ì‹¤í–‰
CREATE EXTENSION IF NOT EXISTS pg_trgm;

-- í™•ì¸
SELECT * FROM pg_extension WHERE extname = 'pg_trgm';
```

**RDS/CloudSQL ë“± ê´€ë¦¬í˜• DB**:
- ëŒ€ë¶€ë¶„ pg_trgmì„ ì§€ì›í•˜ì§€ë§Œ, **ìˆ˜ë™ ì„¤ì¹˜ ê¶Œí•œì´ ì—†ì„ ìˆ˜ ìˆìŒ**
- AWS RDS: Superuser ê¶Œí•œ ë˜ëŠ” rds_superuser ì—­í•  í•„ìš”
- GCP Cloud SQL: `cloudsqlsuperuser` ì—­í•  í•„ìš”

**ê¶Œí•œ ì—†ëŠ” ê²½ìš° Fallback**:
```typescript
// backend/migrations/YYYYMMDDHHMMSS-add-tiptap-fields.ts
public async up(queryRunner: QueryRunner): Promise<void> {
  // ... ê¸°ì¡´ ì»¬ëŸ¼ ì¶”ê°€

  try {
    // âœ… Extension ìƒì„± ì‹œë„
    await queryRunner.query(`CREATE EXTENSION IF NOT EXISTS pg_trgm;`);

    // âœ… pg_trgm ì¸ë±ìŠ¤
    await queryRunner.query(`
      CREATE INDEX idx_posts_plain_text_trgm
      ON posts USING gin(plain_text gin_trgm_ops);
    `);

    console.log('âœ… pg_trgm index created');
  } catch (error) {
    console.warn('âš ï¸ pg_trgm not available, using simple index');

    // âœ… Fallback: simple full-text ì¸ë±ìŠ¤
    await queryRunner.query(`
      CREATE INDEX idx_posts_plain_text_simple
      ON posts USING gin(to_tsvector('simple', plain_text));
    `);
  }
}
```

### 2. ê²€ìƒ‰ ì¿¼ë¦¬ ìˆ˜ì • (ì—°ì‚°ì + similarity)

```typescript
// backend/src/posts/service/posts.service.ts
async getPosts(
  keyword: string = '',
  tag: string = '',
  page: number = 1,
  pageSize: number = 10
): Promise<Post[]> {
  const queryBuilder = this.postRepository
    .createQueryBuilder('post')
    .leftJoinAndSelect('post.tags', 'tag')
    .where('post.status = :status', { status: 'published' });

  // âœ… REVISED: pg_trgm ì—°ì‚°ì ì‚¬ìš©
  if (keyword && keyword.trim().length >= 2) {
    const cleanKeyword = keyword.trim();

    // âœ… pg_trgm ìœ ì‚¬ë„ ë§¤ì¹­ (% ì—°ì‚°ì)
    queryBuilder.andWhere(
      '(post.title % :keyword OR post.plainText % :keyword)',
      { keyword: cleanKeyword }  // âœ… % ì œê±° (raw í‚¤ì›Œë“œ)
    );

    // âœ… ìœ ì‚¬ë„ ê¸°ë°˜ ì •ë ¬
    queryBuilder
      .addSelect(
        `(similarity(post.title, :keyword) + similarity(post.plainText, :keyword) * 0.5)`,
        'relevance'
      )
      .setParameter('keyword', cleanKeyword)
      .orderBy('relevance', 'DESC');
  } else if (!keyword) {
    // í‚¤ì›Œë“œ ì—†ìœ¼ë©´ ìµœì‹ ìˆœ
    queryBuilder.orderBy('post.publishDate', 'DESC');
  }

  // íƒœê·¸ í•„í„°
  if (tag) {
    queryBuilder.andWhere('tag.name = :tag', { tag });
  }

  queryBuilder
    .skip((page - 1) * pageSize)
    .take(pageSize);

  return queryBuilder.getMany();
}
```

**ì—°ì‚°ì ì„¤ëª…**:
- `%`: Trigram ìœ ì‚¬ë„ ë§¤ì¹­ (ê¸°ë³¸ threshold 0.3)
- `similarity()`: 0~1 ì‚¬ì´ ìœ ì‚¬ë„ ë°˜í™˜

**Threshold ì¡°ì •** (ì„ íƒì ):
```typescript
// ê²€ìƒ‰ ì „ì— threshold ì„¤ì •
await queryRunner.query(`SET pg_trgm.similarity_threshold = 0.2;`);
// 0.2 = ë” ë§ì€ ê²°ê³¼ (ì¬í˜„ìœ¨ ì¦ê°€)
// 0.5 = ë” ì •í™•í•œ ê²°ê³¼ (ì •í™•ë„ ì¦ê°€)
```

### 3. Fallback ì¿¼ë¦¬ (pg_trgm ì—†ëŠ” í™˜ê²½)

```typescript
// backend/src/posts/service/posts.service.ts
async getPosts(
  keyword: string = '',
  tag: string = '',
  page: number = 1,
  pageSize: number = 10
): Promise<Post[]> {
  const queryBuilder = this.postRepository
    .createQueryBuilder('post')
    .leftJoinAndSelect('post.tags', 'tag')
    .where('post.status = :status', { status: 'published' });

  if (keyword && keyword.trim().length >= 2) {
    const cleanKeyword = keyword.trim();

    // âœ… pg_trgm ì‚¬ìš© ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸
    const hasPgTrgm = await this.checkPgTrgm();

    if (hasPgTrgm) {
      // âœ… pg_trgm ê²€ìƒ‰
      queryBuilder.andWhere(
        '(post.title % :keyword OR post.plainText % :keyword)',
        { keyword: cleanKeyword }
      );
      queryBuilder.addSelect(
        `(similarity(post.title, :keyword) + similarity(post.plainText, :keyword) * 0.5)`,
        'relevance'
      );
      queryBuilder.orderBy('relevance', 'DESC');
    } else {
      // âœ… Fallback: ILIKE ê²€ìƒ‰
      queryBuilder.andWhere(
        '(post.title ILIKE :keyword OR post.plainText ILIKE :keyword)',
        { keyword: `%${cleanKeyword}%` }
      );
      queryBuilder.orderBy('post.publishDate', 'DESC');
    }

    queryBuilder.setParameter('keyword', cleanKeyword);
  }

  // ... ë‚˜ë¨¸ì§€ ë¡œì§
}

private async checkPgTrgm(): Promise<boolean> {
  try {
    const result = await this.postRepository.query(
      `SELECT 1 FROM pg_extension WHERE extname = 'pg_trgm'`
    );
    return result.length > 0;
  } catch (error) {
    return false;
  }
}
```

---

## ğŸ“ Medium Priority (REVISED)

### F. DOMPurify URI ì œí•œ (MUSTë¡œ ìŠ¹ê²©)

**ì´ë¯¸ Issue A êµ¬í˜„ì— í¬í•¨**:
```typescript
const PURIFY_CONFIG = {
  // ...
  ALLOWED_URI_REGEXP: /^(?:(?:https?|mailto):|[^a-z]|[a-z+.\-]+(?:[^a-z+.\-:]|$))/i,
};
```

**ì´ë¯¸ì§€ data: URI í—ˆìš©** (ì„ íƒì ):
```typescript
const PURIFY_CONFIG = {
  ALLOWED_TAGS: [ /* ... */ ],
  ALLOWED_ATTR: [ /* ... */ ],

  // âœ… ì„¸ë¶„í™”: <a>ëŠ” http/https/mailtoë§Œ, <img>ëŠ” data: í—ˆìš©
  ALLOWED_URI_REGEXP: /^(?:(?:https?|mailto):|[^a-z]|[a-z+.\-]+(?:[^a-z+.\-:]|$))/i,

  // âœ… ì¶”ê°€ ì„¤ì •: img srcë§Œ data: í—ˆìš©
  ADD_URI_SAFE_ATTR: ['src'],  // src ì†ì„±ë§Œ ì¶”ê°€ ê²€ì¦

  // âœ… Hookìœ¼ë¡œ ì„¸ë°€ ì œì–´
  HOOKS: {
    uponSanitizeAttribute: (node, data) => {
      // <img src="data:...">ëŠ” í—ˆìš©, <a href="data:...">ëŠ” ì°¨ë‹¨
      if (data.attrName === 'src' && node.tagName === 'IMG') {
        if (data.attrValue.startsWith('data:image/')) {
          return;  // í—ˆìš©
        }
      }

      if (data.attrName === 'href' && data.attrValue.startsWith('data:')) {
        data.keepAttr = false;  // ì°¨ë‹¨
      }
    },
  },
};
```

### H. contentJson íƒ€ì… ì•ˆì „ì„± (ìµœì†Œ ê²€ì¦)

```typescript
// backend/src/posts/dto/request/create-post-request.dto.ts
import { IsObject, ValidateIf, IsArray, IsInt, Min, Max } from 'class-validator';

export class CreatePostRequestDTO {
  @IsString()
  title: string;

  @ValidateIf(o => o.contentType === 'tiptap-json')
  @IsObject()
  @Validate(TiptapJsonValidator)  // âœ… ì»¤ìŠ¤í…€ ê²€ì¦
  content?: any;

  // ...
}
```

```typescript
// backend/src/posts/validators/tiptap-json.validator.ts
import { ValidatorConstraint, ValidatorConstraintInterface, ValidationArguments } from 'class-validator';

@ValidatorConstraint({ name: 'tiptapJson', async: false })
export class TiptapJsonValidator implements ValidatorConstraintInterface {
  validate(json: any, args: ValidationArguments) {
    // âœ… ìµœì†Œ ê²€ì¦
    if (!json || typeof json !== 'object') {
      return false;
    }

    // âœ… ìµœìƒìœ„ íƒ€ì… í™•ì¸
    if (json.type !== 'doc') {
      return false;
    }

    // âœ… content ë°°ì—´ í™•ì¸
    if (!Array.isArray(json.content)) {
      return false;
    }

    // âœ… Depth ì œí•œ (DoS ë°©ì§€)
    const maxDepth = 10;
    if (!this.validateDepth(json, maxDepth)) {
      return false;
    }

    // âœ… ë…¸ë“œ ìˆ˜ ì œí•œ
    const maxNodes = 10000;
    if (!this.validateNodeCount(json, maxNodes)) {
      return false;
    }

    return true;
  }

  private validateDepth(node: any, maxDepth: number, currentDepth = 0): boolean {
    if (currentDepth > maxDepth) {
      return false;
    }

    if (node.content && Array.isArray(node.content)) {
      for (const child of node.content) {
        if (!this.validateDepth(child, maxDepth, currentDepth + 1)) {
          return false;
        }
      }
    }

    return true;
  }

  private validateNodeCount(node: any, maxNodes: number): boolean {
    let count = 0;

    const traverse = (n: any) => {
      count++;
      if (count > maxNodes) {
        return false;
      }

      if (n.content && Array.isArray(n.content)) {
        for (const child of n.content) {
          if (!traverse(child)) {
            return false;
          }
        }
      }

      return true;
    };

    return traverse(node);
  }

  defaultMessage(args: ValidationArguments) {
    return 'Invalid Tiptap JSON structure';
  }
}
```

### I. ìºì‹œ ë°±í•„ ê²½í•© ì¡°ê±´ (ë°°ì¹˜ ë¶„ë¦¬ ê¶Œì¥)

```typescript
// backend/src/posts/service/posts.service.ts
async getPostById(id: number): Promise<Post> {
  const post = await this.postRepository.findOne({
    where: { id },
    relations: ['tags'],
  });

  if (!post) {
    return null;
  }

  // âœ… REVISED: ìºì‹œ ì—†ìœ¼ë©´ ê²½ê³ ë§Œ ë¡œê¹…, ë°±í•„ì€ ë°°ì¹˜ë¡œ ì²˜ë¦¬
  if (!post.contentHtml) {
    console.warn(`âš ï¸ Post ${id}: Cache missing (will be regenerated by batch job)`);

    // âœ… ì„ì‹œ: ì‹¤ì‹œê°„ ë Œë”ë§ (ìºì‹œ ì €ì¥ ì•ˆ í•¨)
    if (post.contentType === 'tiptap-json' && post.contentJson) {
      const { html } = renderTiptapToHTML(post.contentJson);
      post.contentHtml = html;  // ë©”ëª¨ë¦¬ë§Œ (DB ì €ì¥ X)
    } else if (post.contentType === 'markdown' && post.contentMarkdown) {
      const { html } = renderMarkdownToHTML(post.contentMarkdown);
      post.contentHtml = html;
    }
  }

  return post;
}
```

**ë°°ì¹˜ ì‘ì—…**:
```typescript
// backend/src/posts/tasks/cache-regeneration.task.ts
import { Injectable, Logger } from '@nestjs/common';
import { Cron, CronExpression } from '@nestjs/schedule';
import { PostsService } from '../service/posts.service';

@Injectable()
export class CacheRegenerationTask {
  private readonly logger = new Logger(CacheRegenerationTask.name);

  constructor(private readonly postsService: PostsService) {}

  @Cron(CronExpression.EVERY_DAY_AT_3AM)  // âœ… ë§¤ì¼ ìƒˆë²½ 3ì‹œ
  async handleCacheRegeneration() {
    this.logger.log('Starting cache regeneration...');
    await this.postsService.regenerateAllCaches();
    this.logger.log('Cache regeneration completed');
  }
}
```

---

## âœ… v3.1 REVISED ì²´í¬ë¦¬ìŠ¤íŠ¸

### ë°°í¬ ì „ í•„ìˆ˜ (MUST FIX)

- [ ] **A. TOC**: HTML í›„ì²˜ë¦¬ + dedupe êµ¬í˜„
  - [ ] `heading-processor.ts` ìƒì„±
  - [ ] `injectHeadingIds()` í•¨ìˆ˜ í…ŒìŠ¤íŠ¸
  - [ ] ì¤‘ë³µ ì œëª© E2E í…ŒìŠ¤íŠ¸

- [ ] **B. Auth**: ìš´ì˜ ì „ì œ í™•ì¸
  - [ ] CORS origin ì •í™•íˆ ì„¤ì • (`*` ê¸ˆì§€)
  - [ ] Cookie domain í™˜ê²½ë³„ ë¶„ê¸°
  - [ ] Origin/Referer ê²€ì¦ Guard ì¶”ê°€
  - [ ] ë¯¸ë“¤ì›¨ì–´ ê²€ì¦ ìµœì†Œí™”

- [ ] **C. Edge**: base64url nonce ìƒì„±
  - [ ] `generateNonce()` í•¨ìˆ˜ ê²€ì¦

- [ ] **D. CSP**: style unsafe-inline í—ˆìš©
  - [ ] CSP í—¤ë” ìˆ˜ì •
  - [ ] inline script nonce ì ìš© (í•„ìš” ì‹œ)

- [ ] **E. Search**: pg_trgm ìš´ì˜ ì ˆì°¨
  - [ ] Extension ì„¤ì¹˜ (DBA/Infra)
  - [ ] Migration fallback ì¶”ê°€
  - [ ] ê²€ìƒ‰ ì¿¼ë¦¬ `%` ì—°ì‚°ì ìˆ˜ì •

### ê¶Œì¥ (Medium Priority)

- [ ] **F. DOMPurify**: URI ì œí•œ (ì´ë¯¸ í¬í•¨)
- [ ] **H. contentJson**: ìµœì†Œ ê²€ì¦ ì¶”ê°€
- [ ] **I. ìºì‹œ ë°±í•„**: ë°°ì¹˜ ì‘ì—… ë¶„ë¦¬

---

## ğŸ“Š ë³€ê²½ ì‚¬í•­ ìš”ì•½ (v3.1 â†’ REVISED)

| ì´ìŠˆ | v3.1 (ì´ë¡ ) | REVISED (ì‹¤ì „) |
|------|------------|---------------|
| **A. TOC** | Extension ì»¤ìŠ¤í„°ë§ˆì´ì§• | âœ… HTML í›„ì²˜ë¦¬ í†µì¼ + dedupe |
| **B. Auth** | Cookie ê¸°ë°˜ (ì „ì œ ëˆ„ë½) | âœ… CORS/Domain/CSRF ëª…ë¬¸í™” |
| **C. Edge** | Web Crypto (OK) | âœ… base64url ì•ˆì •í™” |
| **D. CSP** | Context ì „íŒŒ (ë¶ˆê°€ëŠ¥) | âœ… style unsafe-inline í—ˆìš© |
| **E. Search** | pg_trgm (ê¶Œí•œ ì´ìŠˆ) | âœ… ìš´ì˜ ì ˆì°¨ + `%` ì—°ì‚°ì |

---

**ë¬¸ì„œ ë²„ì „**: 3.1 REVISED
**ì‘ì„±ì¼**: 2025-12-30
**ê²€ì¦ ìƒíƒœ**: ì‹¤ì œ ë™ì‘ ê°€ëŠ¥í•œ ì½”ë“œ
**ì˜ˆìƒ ì‘ì—… ì‹œê°„**: 6-8ì‹œê°„ (High Priority)