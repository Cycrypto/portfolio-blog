# Tiptap ì—ë””í„° ì „í™˜ - ì•„í‚¤í…ì²˜ ì„¤ê³„ ë° ë§ˆì´ê·¸ë ˆì´ì…˜ ê³„íš

## ğŸ“‹ ë¬¸ì„œ ì •ë³´

- **ì‘ì„±ì¼**: 2025-12-30
- **ë²„ì „**: 1.0 (Architecture & Migration Plan)
- **ëª©ì **: ì½”ë“œ ë ˆë²¨ ì„¸ë¶€ì‚¬í•­ ì—†ì´ ì „ì²´ êµ¬ì¡° ë° ì „í™˜ ì „ëµ ìˆ˜ë¦½
- **ì°¸ì¡° ë¬¸ì„œ**: docs 6-12 (ìƒì„¸ ê¸°ìˆ  êµ¬í˜„)

---

## ğŸ¯ 1. í˜„ì¬ ìƒíƒœ ë¶„ì„

### 1.1 ê¸°ìˆ  ìŠ¤íƒ í˜„í™©

#### Backend (NestJS + TypeORM + PostgreSQL)
```
â”œâ”€â”€ Auth: JWT ê¸°ë°˜ ì¸ì¦ (ê°œë°œìš© í† í° ë°œê¸‰ ë°©ì‹)
â”œâ”€â”€ Posts: Markdown ê¸°ë°˜ ë¸”ë¡œê·¸ í¬ìŠ¤íŠ¸
â”œâ”€â”€ Comments: ëŒ“ê¸€ ì‹œìŠ¤í…œ
â”œâ”€â”€ Profile/Projects/Experience/Contact: í¬íŠ¸í´ë¦¬ì˜¤ ê¸°ëŠ¥
â”œâ”€â”€ Media: íŒŒì¼ ì—…ë¡œë“œ
â””â”€â”€ Stats: í†µê³„
```

**í•µì‹¬ êµ¬ì¡°**:
- Post Entity: `content` í•„ë“œì— Markdown í…ìŠ¤íŠ¸ ì €ì¥ (TEXT íƒ€ì…)
- ì¸ì¦: JWT í† í° (í˜„ì¬ HttpOnly Cookie ì—†ì´ Bearer ë°©ì‹)
- DB: PostgreSQL (synchronize: trueë¡œ ê°œë°œ ì¤‘)

#### Frontend (Next.js 14 App Router + React)
```
â”œâ”€â”€ Public: ë¸”ë¡œê·¸/í”„ë¡œì íŠ¸ ì¡°íšŒ í˜ì´ì§€
â”œâ”€â”€ Admin: ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ (í¬ìŠ¤íŠ¸/í”„ë¡œì íŠ¸ ê´€ë¦¬)
â””â”€â”€ Editor: @uiw/react-md-editor (Markdown WYSIWYG)
```

**í•µì‹¬ êµ¬ì¡°**:
- Client Component ê¸°ë°˜ ê´€ë¦¬ì í˜ì´ì§€
- Markdown ì—ë””í„°: ì‹¤ì‹œê°„ ë¯¸ë¦¬ë³´ê¸° ì œê³µ
- ìƒíƒœ ê´€ë¦¬: useState ê¸°ë°˜ ë¡œì»¬ ìƒíƒœ

### 1.2 í˜„ì¬ ì‹œìŠ¤í…œì˜ ê°•ì 

| ì˜ì—­ | ê°•ì  | ìœ ì§€ ì „ëµ |
|------|------|----------|
| **Backend êµ¬ì¡°** | NestJS ëª¨ë“ˆí™”, TypeORM ê¸°ë°˜ | âœ… í˜„ì¬ êµ¬ì¡° ìœ ì§€ |
| **ì¸ì¦ ì‹œìŠ¤í…œ** | JWT ê¸°ë°˜ ì¸ì¦ ì´ë¯¸ êµ¬í˜„ | âœ… í˜„ì¬ ë°©ì‹ ìœ ì§€ |
| **DB ì„¤ê³„** | Entity ê´€ê³„ ëª…í™• | âœ… ì»¬ëŸ¼ ì¶”ê°€ë¡œ í™•ì¥ |
| **í”„ë¡ íŠ¸ êµ¬ì¡°** | App Router ê¸°ë°˜ | âœ… SSR/CSR í˜¼í•© í™œìš© |

### 1.3 í˜„ì¬ ì‹œìŠ¤í…œì˜ ê°œì„  í•„ìš” ì˜ì—­

| ì˜ì—­ | ë¬¸ì œì  | ìš°ì„ ìˆœìœ„ | í•´ê²° ë°©í–¥ |
|------|--------|---------|----------|
| **ì—ë””í„° ê¸°ëŠ¥** | Markdown ì œì•½ (í‘œ, ì´ë¯¸ì§€ ì •ë ¬ ë“±) | ğŸ”´ High | Tiptap ì „í™˜ |
| **ì½˜í…ì¸  ë³´ì•ˆ** | XSS ë°©ì–´ ì—†ìŒ | ğŸ”´ High | ì„œë²„ Sanitize (DOMPurify) |
| **ê²€ìƒ‰** | ì „ì²´ í…ìŠ¤íŠ¸ ê²€ìƒ‰ ì—†ìŒ | ğŸŸ¡ Medium | PostgreSQL FTS |
| **ìºì‹±** | ë Œë”ë§ ìºì‹œ ì—†ìŒ | ğŸŸ¢ Low | ë¯¸ë¦¬ ìƒì„± ì „ëµ |
| **SEO** | í´ë¼ì´ì–¸íŠ¸ ë Œë”ë§ ì˜ì¡´ | ğŸŸ¡ Medium | SSR ë Œë”ë§ |

> **ì°¸ê³ **: ì¸ì¦/ë³´ì•ˆ ê°•í™” (CSRF, HttpOnly Cookie)ëŠ” ì´ë²ˆ Tiptap ì „í™˜ ë²”ìœ„ì—ì„œ **ì œì™¸**ë˜ë©°, ë³„ë„ í”„ë¡œì íŠ¸ë¡œ ì§„í–‰ ì˜ˆì •

---

## ğŸ“Š 2. ë¬¸ì„œ 6-12 ë³€ê²½ ì‚¬í•­ ìš”ì•½ ë° ì˜í–¥ ë¶„ì„

### 2.1 ì£¼ìš” ê¸°ìˆ  ê²°ì • ì‚¬í•­

| ë¬¸ì„œ | í•µì‹¬ ê²°ì • | ì˜í–¥ ë²”ìœ„ | ë³µì¡ë„ |
|------|----------|----------|--------|
| **v3.0** | Tiptap JSON â†’ Server HTML ë Œë”ë§ | Backend/Frontend | Medium |
| **v3.1** | TOC HTML í›„ì²˜ë¦¬, CSRF Double Submit | Backend | High |
| **v3.1 REVISED** | CSRF ì‹¤ì „ íŒ¨ì¹˜, pg_trgm ê²€ìƒ‰ | Backend/Infra | Medium |
| **v3.1 FINAL** | DOMPurify Hook, ìºì‹œ ì „ëµ | Backend | Medium |
| **v3.1 FINAL PATCH** | CSRF ìš°íšŒ ì œê±°, clearCookie ìˆ˜ì • | Backend | Low |
| **v3.1 PRODUCTION READY** | ì˜ˆì‹œ ì •ë¦¬, srcset ì°¨ë‹¨ | Backend | Low |
| **v3.1 PRODUCTION PATCH** | SameSite Lax, Cookie ëª…ì‹œì  êµ¬ì„± | Backend/Frontend | Medium |

### 2.2 ì•„í‚¤í…ì²˜ ë ˆë²¨ ë³€ê²½ ì‚¬í•­

#### 2.2.1 ë°ì´í„° ëª¨ë¸ ë³€ê²½

**í˜„ì¬ (AS-IS)**:
```
Post {
  content: string (TEXT)  // Markdown ì›ë³¸
}
```

**ëª©í‘œ (TO-BE)**:
```
Post {
  // ì›ë³¸ ì €ì¥
  contentType: 'markdown' | 'tiptap'
  contentMarkdown: string (TEXT, nullable)
  contentJson: JSONContent (JSONB, nullable)

  // ìºì‹œ í•„ë“œ (ì €ì¥ ì‹œ ìë™ ìƒì„±)
  contentHtml: string (TEXT)        // Sanitized HTML
  plainText: string (TEXT)          // ê²€ìƒ‰ìš©
  headings: JSON                     // TOCìš©
  wordCount: number
}
```

**ì˜í–¥ ë¶„ì„**:
- âœ… ê¸°ì¡´ Markdown í¬ìŠ¤íŠ¸ í˜¸í™˜ (contentMarkdown ìœ ì§€)
- âœ… ì‹ ê·œ Tiptap í¬ìŠ¤íŠ¸ ì¶”ê°€ (contentJson ì‚¬ìš©)
- âš ï¸ TypeORM Migration í•„ìš” (ì»¬ëŸ¼ ì¶”ê°€)
- âš ï¸ ê¸°ì¡´ ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜ (content â†’ contentMarkdown)

#### 2.2.2 ì½˜í…ì¸  ë³´ì•ˆ ë³€ê²½ (XSS ë°©ì–´)

**í˜„ì¬ (AS-IS)**:
```
- XSS ë°©ì–´ ì—†ìŒ
- í´ë¼ì´ì–¸íŠ¸ Markdown ë Œë”ë§
```

**ëª©í‘œ (TO-BE)**:
```
- DOMPurify ì„œë²„ Sanitization (ë‹¨ì¼ ë³´ì•ˆ ì§€ì )
- ì„œë²„ HTML ìƒì„± â†’ í´ë¼ì´ì–¸íŠ¸ í‘œì‹œ
```

**ì˜í–¥ ë¶„ì„**:
- âœ… ê¸°ì¡´ ì¸ì¦ ë°©ì‹ ìœ ì§€ (JWT Bearer)
- ğŸ”´ Backendì— ë Œë”ë§ ë¡œì§ ì¶”ê°€
- âš ï¸ DOMPurify Hook ì„¤ì • í•„ìš”

> **ì°¸ê³ **: CSRF, HttpOnly Cookie ë“± ì¸ì¦ ë³´ì•ˆ ê°•í™”ëŠ” ë³„ë„ í”„ë¡œì íŠ¸

#### 2.2.3 ë Œë”ë§ ì „ëµ ë³€ê²½

**í˜„ì¬ (AS-IS)**:
```
Frontend (Client Component)
â””â”€â”€ MDEditor (Markdown í´ë¼ì´ì–¸íŠ¸ ë Œë”ë§)
```

**ëª©í‘œ (TO-BE)**:
```
ê´€ë¦¬ì:
  Frontend (Client Component)
  â””â”€â”€ Tiptap Editor (WYSIWYG)

ì‚¬ìš©ì:
  Backend (Server-side)
  â””â”€â”€ Tiptap/Marked â†’ DOMPurify â†’ HTML
       Frontend (Server Component)
       â””â”€â”€ dangerouslySetInnerHTML
```

**ì˜í–¥ ë¶„ì„**:
- âœ… ê´€ë¦¬ì: ê¸°ì¡´ êµ¬ì¡° ìœ ì§€ (MDEditor â†’ Tiptap êµì²´ë§Œ)
- âš ï¸ ì‚¬ìš©ì: ë Œë”ë§ ë¡œì§ Backendë¡œ ì´ë™
- âš ï¸ SEO ê°œì„  (ì„œë²„ HTML ë Œë”ë§)

---

## ğŸ—ï¸ 3. ë§ˆì´ê·¸ë ˆì´ì…˜ ì „ëµ

### 3.1 ì ì§„ì  ì „í™˜ ì›ì¹™

#### Phase ì ‘ê·¼ë²• (Big Bang ë°©ì§€)

```
Phase 0: ê¸°ë°˜ êµ¬ì¶• (ì¸í”„ë¼)
  â”œâ”€â”€ DOMPurify ì„¤ì • (XSS ë°©ì–´)
  â””â”€â”€ DB ì»¬ëŸ¼ ì¶”ê°€ (Migration)

Phase 1: Backend ë Œë”ë§ í†µí•©
  â”œâ”€â”€ Markdown â†’ HTML ë³€í™˜ê¸°
  â”œâ”€â”€ Tiptap JSON â†’ HTML ë³€í™˜ê¸°
  â”œâ”€â”€ Heading ì¶”ì¶œê¸° (TOC)
  â””â”€â”€ ìºì‹œ í•„ë“œ ìë™ ìƒì„±

Phase 2: Admin ì—ë””í„° ì „í™˜
  â”œâ”€â”€ Tiptap ì—ë””í„° UI
  â”œâ”€â”€ Image Upload Extension
  â”œâ”€â”€ ì €ì¥ ë¡œì§ ìˆ˜ì • (JSON ì €ì¥)
  â””â”€â”€ ê¸°ì¡´ Markdown í¸ì§‘ ì§€ì›

Phase 3: ê²€ìƒ‰ ê³ ë„í™”
  â”œâ”€â”€ pg_trgm ì„¤ì¹˜
  â”œâ”€â”€ GIN ì¸ë±ìŠ¤ ìƒì„±
  â””â”€â”€ ê²€ìƒ‰ API ê°œì„ 

Phase 4: ìš´ì˜ ì•ˆì •í™”
  â”œâ”€â”€ ìºì‹± ì „ëµ ì ìš©
  â”œâ”€â”€ ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§
  â””â”€â”€ ë¡¤ë°± í”Œëœ ê²€ì¦
```

> **ë²”ìœ„ ì œì™¸**: CSRF Guard, Cookie ì¸ì¦ ì „í™˜ì€ ë³„ë„ ë³´ì•ˆ ê°•í™” í”„ë¡œì íŠ¸ë¡œ ë¶„ë¦¬

### 3.2 Backward Compatibility ì „ëµ

#### ê¸°ì¡´ Markdown í¬ìŠ¤íŠ¸ ì²˜ë¦¬

**ì„¤ê³„ ì›ì¹™**:
- ê¸°ì¡´ í¬ìŠ¤íŠ¸ëŠ” `contentType: 'markdown'` ìœ ì§€
- í¸ì§‘ ì‹œì—ë„ Markdownìœ¼ë¡œ í¸ì§‘ ê°€ëŠ¥
- ë Œë”ë§ì€ ë™ì¼í•œ íŒŒì´í”„ë¼ì¸ (Server HTML)

**êµ¬í˜„ ë°©ì‹**:
```
if (post.contentType === 'markdown') {
  // Markdown â†’ HTML (Marked)
  html = marked(post.contentMarkdown)
} else {
  // Tiptap JSON â†’ HTML
  html = generateHTML(post.contentJson, extensions)
}

// ê³µí†µ íŒŒì´í”„ë¼ì¸
sanitizedHtml = DOMPurify.sanitize(html)
headings = extractHeadings(sanitizedHtml)
```

**ì¥ì **:
- âœ… ê¸°ì¡´ ë°ì´í„° ì†ì‹¤ ì—†ìŒ
- âœ… ì ì§„ì  ì „í™˜ ê°€ëŠ¥ (ê´€ë¦¬ì ì„ íƒ)
- âœ… ë¡¤ë°± ì‹œë‚˜ë¦¬ì˜¤ ë‹¨ìˆœ

### 3.3 ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜ ê³„íš

#### Step 1: ìŠ¤í‚¤ë§ˆ í™•ì¥ (ë¬´ì¤‘ë‹¨)

```sql
-- Migration 1: ì»¬ëŸ¼ ì¶”ê°€ (NULL í—ˆìš©)
ALTER TABLE posts ADD COLUMN content_type VARCHAR(20) DEFAULT 'markdown';
ALTER TABLE posts ADD COLUMN content_markdown TEXT;
ALTER TABLE posts ADD COLUMN content_json JSONB;
ALTER TABLE posts ADD COLUMN content_html TEXT;
ALTER TABLE posts ADD COLUMN plain_text TEXT;
ALTER TABLE posts ADD COLUMN headings JSONB;
ALTER TABLE posts ADD COLUMN word_count INTEGER DEFAULT 0;

-- Migration 2: ê¸°ì¡´ ë°ì´í„° ë³µì‚¬
UPDATE posts SET content_markdown = content WHERE content IS NOT NULL;

-- Migration 3: ìºì‹œ í•„ë“œ ë°±í•„ (ë°°ì¹˜ ì‘ì—…)
-- (ë³„ë„ ìŠ¤í¬ë¦½íŠ¸ë¡œ ì‹¤í–‰)
```

**ì˜í–¥**:
- âš ï¸ ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰ ì¦ê°€ (ìºì‹œ í•„ë“œ)
- âš ï¸ ë°±í•„ ì‘ì—… ì‹œê°„ (í¬ìŠ¤íŠ¸ ìˆ˜ì— ë¹„ë¡€)
- âœ… ì„œë¹„ìŠ¤ ì¤‘ë‹¨ ì—†ìŒ

#### Step 2: ë°±í•„ ìŠ¤í¬ë¦½íŠ¸

**ì „ëµ**:
- Batch ì²˜ë¦¬ (100ê°œì”©)
- ì˜¤ë˜ëœ í¬ìŠ¤íŠ¸ë¶€í„° ì²˜ë¦¬
- ì‹¤íŒ¨ ì‹œ ì¬ì‹œë„ ë¡œì§
- ì§„í–‰ë¥  ë¡œê¹…

**ì‹¤í–‰ ì‹œì **:
- ì˜¤í”„í”¼í¬ ì‹œê°„ (ìƒˆë²½ 2-4ì‹œ)
- ë˜ëŠ” ìˆœì°¨ì  ì§€ì—° ì‹¤í–‰

---

## ğŸ”„ 4. ì‹œìŠ¤í…œ ì˜í–¥ë„ ë¶„ì„

### 4.1 Backend ì˜í–¥ë„

| ëª¨ë“ˆ | ë³€ê²½ í•„ìš” | ì˜í–¥ë„ | ì˜ˆìƒ ê³µìˆ˜ |
|------|----------|--------|----------|
| **Auth** | CSRF Guard, Cookie ì¸ì¦ | ğŸ”´ High | 3-5ì¼ |
| **Posts Service** | ë Œë”ë§ ë¡œì§ ì¶”ê°€ | ğŸ”´ High | 5-7ì¼ |
| **Posts Entity** | ì»¬ëŸ¼ ì¶”ê°€, Migration | ğŸŸ¡ Medium | 2-3ì¼ |
| **Posts Controller** | DTO ë³€ê²½ | ğŸŸ¢ Low | 1-2ì¼ |
| **ë‹¤ë¥¸ ëª¨ë“ˆ** | ì˜í–¥ ì—†ìŒ | âœ… None | 0ì¼ |

**ì´ ì˜ˆìƒ ê³µìˆ˜**: 11-17ì¼

### 4.2 Frontend ì˜í–¥ë„

| ì˜ì—­ | ë³€ê²½ í•„ìš” | ì˜í–¥ë„ | ì˜ˆìƒ ê³µìˆ˜ |
|------|----------|--------|----------|
| **Admin ì—ë””í„°** | MDEditor â†’ Tiptap | ğŸ”´ High | 3-4ì¼ |
| **Admin API í˜¸ì¶œ** | Cookie ê¸°ë°˜ ì „í™˜ | ğŸŸ¡ Medium | 2-3ì¼ |
| **ì‚¬ìš©ì ì½ê¸°** | Server Componentí™” | ğŸŸ¢ Low | 1-2ì¼ |
| **Middleware** | CSP í—¤ë” ì¶”ê°€ | ğŸŸ¢ Low | 1ì¼ |

**ì´ ì˜ˆìƒ ê³µìˆ˜**: 7-10ì¼

### 4.3 Infrastructure ì˜í–¥ë„

| í•­ëª© | ë³€ê²½ í•„ìš” | ë¹„ê³  |
|------|----------|------|
| **PostgreSQL** | pg_trgm extension ì„¤ì¹˜ | ìŠˆí¼ìœ ì € ê¶Œí•œ í•„ìš” |
| **í™˜ê²½ë³€ìˆ˜** | COOKIE_DOMAIN, CSRF_SECRET ì¶”ê°€ | - |
| **ë°°í¬ í”„ë¡œì„¸ìŠ¤** | Migration ì‹¤í–‰ ìˆœì„œ | ë¬´ì¤‘ë‹¨ ë°°í¬ ê³ ë ¤ |
| **ëª¨ë‹ˆí„°ë§** | ìºì‹œ ì ì¤‘ë¥ , ê²€ìƒ‰ ì„±ëŠ¥ | ì‹ ê·œ ë©”íŠ¸ë¦­ |

---

## ğŸ“¦ 5. í•µì‹¬ ì»´í¬ë„ŒíŠ¸ ì„¤ê³„

### 5.1 ë Œë”ë§ íŒŒì´í”„ë¼ì¸

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Content Rendering Pipeline          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Input: Post (contentType, contentMarkdown | contentJson)
  â”‚
  â”œâ”€ [contentType === 'markdown']
  â”‚   â””â”€â†’ marked() â†’ Raw HTML
  â”‚
  â””â”€ [contentType === 'tiptap']
      â””â”€â†’ generateHTML(contentJson, extensions) â†’ Raw HTML

  â†“

Common Pipeline:
  â”‚
  â”œâ”€â†’ DOMPurify.sanitize() â†’ Safe HTML
  â”œâ”€â†’ injectHeadingIds() â†’ HTML + headings[]
  â”œâ”€â†’ generateText() â†’ Plain Text
  â””â”€â†’ wordCount calculation

  â†“

Output: {
  contentHtml: string,
  headings: Array<{level, text, id}>,
  plainText: string,
  wordCount: number
}
```

**í•µì‹¬ ì„¤ê³„ ì›ì¹™**:
- ë‹¨ì¼ íŒŒì´í”„ë¼ì¸ (ì½˜í…ì¸  íƒ€ì… ë¬´ê´€)
- ë³´ì•ˆ ê²€ì¦ ë‹¨ì¼ ì§€ì  (DOMPurify)
- ìºì‹œ ìë™ ê°±ì‹  (ì €ì¥ ì‹œ)

### 5.2 ì¸ì¦/ë³´ì•ˆ ë ˆì´ì–´

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Security Architecture             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Client (Browser)
  â”‚
  â”œâ”€ Cookie: auth-token (HttpOnly, SameSite=Lax)
  â”œâ”€ Cookie: csrf-token (NOT HttpOnly)
  â””â”€ Header: X-CSRF-Token (mutations only)

  â†“

Middleware (Next.js)
  â””â”€â†’ CSP Header (nonce-based)

  â†“

Backend (NestJS)
  â”‚
  â”œâ”€ JwtAuthGuard: Cookieì—ì„œ í† í° ì¶”ì¶œ
  â”œâ”€ CsrfGuard: Double Submit ê²€ì¦ (POST/PATCH/DELETE)
  â””â”€ RoleGuard: ê´€ë¦¬ì ê¶Œí•œ í™•ì¸

  â†“

Service Layer
  â””â”€â†’ DOMPurify: HTML Sanitization
```

**ë³´ì•ˆ ê²½ê³„**:
1. **ì…ë ¥ ê²€ì¦**: DTO + class-validator
2. **ì¸ì¦**: JWT (HttpOnly Cookie)
3. **CSRF**: Double Submit Cookie
4. **XSS**: DOMPurify (ì„œë²„ ë‹¨ì¼ ì§€ì )
5. **CSP**: ì¸ë¼ì¸ ìŠ¤í¬ë¦½íŠ¸/ìŠ¤íƒ€ì¼ ì°¨ë‹¨

### 5.3 ì—ë””í„° êµ¬ì¡°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             Editor Architecture             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Admin UI (Client Component)
  â”‚
  â”œâ”€ Tiptap Editor
  â”‚   â”œâ”€ StarterKit (ê¸°ë³¸ ê¸°ëŠ¥)
  â”‚   â”œâ”€ Image Extension (ì—…ë¡œë“œ)
  â”‚   â”œâ”€ Table Extension
  â”‚   â”œâ”€ Code Block (Syntax Highlight)
  â”‚   â””â”€ Custom Toolbar
  â”‚
  â”œâ”€ Save Handler
  â”‚   â””â”€â†’ editor.getJSON() â†’ Backend
  â”‚
  â””â”€ Load Handler
      â””â”€â†’ Backend â†’ editor.commands.setContent(json)

Backend
  â”‚
  â””â”€ POST /posts
      â”œâ”€ Validate DTO
      â”œâ”€ contentJson â†’ contentHtml (ìºì‹œ)
      â””â”€ Save to DB
```

**ì—ë””í„° ê¸°ëŠ¥**:
- WYSIWYG í¸ì§‘ (ì‹¤ì‹œê°„ ë¯¸ë¦¬ë³´ê¸°)
- ì´ë¯¸ì§€ ì—…ë¡œë“œ (ë“œë˜ê·¸ì•¤ë“œë¡­)
- í‘œ í¸ì§‘
- ì½”ë“œ ë¸”ë¡ (Syntax Highlighting)
- ê¸°ì¡´ Markdown í¸ì§‘ ì§€ì›

---

## ğŸš€ 6. ë‹¨ê³„ë³„ ì‹¤í–‰ ê³„íš

### Phase 0: ê¸°ë°˜ êµ¬ì¶• (Week 1-2)

**ëª©í‘œ**: ë³´ì•ˆ/ì¸í”„ë¼ ì¤€ë¹„

#### Backend
- [ ] CSRF Guard êµ¬í˜„
- [ ] Cookie ê¸°ë°˜ ì¸ì¦ ì „í™˜
- [ ] DOMPurify ì„¤ì • ë° í…ŒìŠ¤íŠ¸
- [ ] Migration íŒŒì¼ ì‘ì„± (ì»¬ëŸ¼ ì¶”ê°€)

#### Frontend
- [ ] Middleware CSP í—¤ë” ì¶”ê°€
- [ ] API í´ë¼ì´ì–¸íŠ¸ Cookie ì§€ì›
- [ ] CSRF í† í° ì²˜ë¦¬ ë¡œì§

#### Infrastructure
- [ ] ê°œë°œ í™˜ê²½ pg_trgm ì„¤ì¹˜
- [ ] í™˜ê²½ë³€ìˆ˜ ì¶”ê°€ (COOKIE_DOMAIN ë“±)

**ì™„ë£Œ ì¡°ê±´**:
- âœ… CSRF í† í° ì •ìƒ ë™ì‘
- âœ… Cookie ì¸ì¦ í…ŒìŠ¤íŠ¸ í†µê³¼
- âœ… CSP í—¤ë” ì ìš© í™•ì¸

---

### Phase 1: Backend ë Œë”ë§ í†µí•© (Week 3-4)

**ëª©í‘œ**: ì½˜í…ì¸  ë Œë”ë§ íŒŒì´í”„ë¼ì¸ êµ¬ì¶•

#### Backend
- [ ] ContentRenderer ì„œë¹„ìŠ¤ êµ¬í˜„
  - Markdown â†’ HTML ë³€í™˜ê¸°
  - Tiptap JSON â†’ HTML ë³€í™˜ê¸° (ê¸°ë³¸ Extensions)
  - HeadingProcessor (TOC ì¶”ì¶œ)
- [ ] Post Service ìˆ˜ì •
  - ì €ì¥ ì‹œ ìºì‹œ í•„ë“œ ìë™ ìƒì„±
  - ì¡°íšŒ ì‹œ ìºì‹œ ìš°ì„  ë°˜í™˜
- [ ] Migration ì‹¤í–‰ ë° ê²€ì¦

#### Frontend
- [ ] ì‚¬ìš©ì ì½ê¸° í˜ì´ì§€ SSR ì „í™˜
- [ ] contentHtml ë Œë”ë§ (dangerouslySetInnerHTML)
- [ ] TOC ì»´í¬ë„ŒíŠ¸ êµ¬í˜„

**ì™„ë£Œ ì¡°ê±´**:
- âœ… ê¸°ì¡´ Markdown í¬ìŠ¤íŠ¸ ì •ìƒ ë Œë”ë§
- âœ… TOC ë§í¬ ì •ìƒ ë™ì‘
- âœ… Migration ë¡¤ë°± í…ŒìŠ¤íŠ¸ í†µê³¼

---

### Phase 2: Admin ì—ë””í„° ì „í™˜ (Week 5-6)

**ëª©í‘œ**: Tiptap ì—ë””í„° ì ìš©

#### Frontend
- [ ] Tiptap ì—ë””í„° ì»´í¬ë„ŒíŠ¸ êµ¬í˜„
  - StarterKit ì„¤ì •
  - Image Extension (ì—…ë¡œë“œ)
  - Toolbar UI
- [ ] ì €ì¥ ë¡œì§ ìˆ˜ì • (JSON ì €ì¥)
- [ ] í¸ì§‘ í˜ì´ì§€ ìˆ˜ì •
  - contentType ì„ íƒ UI
  - Markdown â†” Tiptap ì „í™˜ ì§€ì›

#### Backend
- [ ] Tiptap Extensions ì„¤ì •
- [ ] Image Upload API ì—°ë™
- [ ] DTO ìˆ˜ì • (contentJson ì¶”ê°€)

**ì™„ë£Œ ì¡°ê±´**:
- âœ… Tiptapìœ¼ë¡œ ì‹ ê·œ í¬ìŠ¤íŠ¸ ì‘ì„±/ì €ì¥
- âœ… ê¸°ì¡´ Markdown í¬ìŠ¤íŠ¸ í¸ì§‘ ê°€ëŠ¥
- âœ… ì´ë¯¸ì§€ ì—…ë¡œë“œ ì •ìƒ ë™ì‘

---

### Phase 3: ê²€ìƒ‰ ê³ ë„í™” (Week 7)

**ëª©í‘œ**: PostgreSQL FTS ì ìš©

#### Backend
- [ ] pg_trgm GIN ì¸ë±ìŠ¤ ìƒì„±
- [ ] ê²€ìƒ‰ ì¿¼ë¦¬ ê°œì„  (similarity ì‚¬ìš©)
- [ ] ê²€ìƒ‰ API ì„±ëŠ¥ í…ŒìŠ¤íŠ¸

#### Infrastructure
- [ ] Production pg_trgm ì„¤ì¹˜ ê³„íš
- [ ] ì¸ë±ìŠ¤ ìƒì„± ëª¨ë‹ˆí„°ë§

**ì™„ë£Œ ì¡°ê±´**:
- âœ… í•œêµ­ì–´ ê²€ìƒ‰ ì •í™•ë„ ê°œì„ 
- âœ… ê²€ìƒ‰ ì„±ëŠ¥ ë²¤ì¹˜ë§ˆí¬

---

### Phase 4: ìš´ì˜ ì•ˆì •í™” (Week 8)

**ëª©í‘œ**: í”„ë¡œë•ì…˜ ë°°í¬ ì¤€ë¹„

#### í…ŒìŠ¤íŠ¸
- [ ] E2E í…ŒìŠ¤íŠ¸ (Playwright)
- [ ] ë¶€í•˜ í…ŒìŠ¤íŠ¸ (Artillery)
- [ ] ë³´ì•ˆ í…ŒìŠ¤íŠ¸ (CSRF, XSS)

#### ëª¨ë‹ˆí„°ë§
- [ ] ìºì‹œ ì ì¤‘ë¥  ë©”íŠ¸ë¦­
- [ ] ë Œë”ë§ ì„±ëŠ¥ ë©”íŠ¸ë¦­
- [ ] ì—ëŸ¬ ë¡œê¹… (Sentry ë“±)

#### ë°°í¬
- [ ] Staging ë°°í¬ ë° ê²€ì¦
- [ ] ë¡¤ë°± í”Œëœ ìˆ˜ë¦½
- [ ] Production ë°°í¬

**ì™„ë£Œ ì¡°ê±´**:
- âœ… ëª¨ë“  í…ŒìŠ¤íŠ¸ í†µê³¼
- âœ… ì„±ëŠ¥ ëª©í‘œ ë‹¬ì„± (ë Œë”ë§ < 100ms)
- âœ… ë¡¤ë°± ì‹œë‚˜ë¦¬ì˜¤ ê²€ì¦

---

## ğŸ” 7. ë¦¬ìŠ¤í¬ ë° ëŒ€ì‘ ì „ëµ

### 7.1 ê¸°ìˆ ì  ë¦¬ìŠ¤í¬

| ë¦¬ìŠ¤í¬ | í™•ë¥  | ì˜í–¥ | ëŒ€ì‘ ì „ëµ |
|--------|------|------|----------|
| **Migration ì‹¤íŒ¨** | Low | High | ë¡¤ë°± ìŠ¤í¬ë¦½íŠ¸ ì‚¬ì „ ì¤€ë¹„, Staging ê²€ì¦ |
| **ì„±ëŠ¥ ì €í•˜** | Medium | Medium | ìºì‹± ì „ëµ, ì¸ë±ì‹±, ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§ |
| **ë³´ì•ˆ ì·¨ì•½ì ** | Low | High | ë³´ì•ˆ í…ŒìŠ¤íŠ¸, ì½”ë“œ ë¦¬ë·°, ë¬¸ì„œ 6-12 ì¤€ìˆ˜ |
| **ë°ì´í„° ì†ì‹¤** | Very Low | High | ë°±ì—… ì „ëµ, íŠ¸ëœì­ì…˜ ì²˜ë¦¬ |
| **Tiptap í˜¸í™˜ì„±** | Low | Medium | POC ë¨¼ì € ì§„í–‰, í´ë°± ì˜µì…˜ |

### 7.2 ìš´ì˜ ë¦¬ìŠ¤í¬

| ë¦¬ìŠ¤í¬ | í™•ë¥  | ì˜í–¥ | ëŒ€ì‘ ì „ëµ |
|--------|------|------|----------|
| **ì‚¬ìš©ì í•™ìŠµ ê³¡ì„ ** | Medium | Low | ê´€ë¦¬ì ê°€ì´ë“œ ì œê³µ |
| **ê¸°ì¡´ ì½˜í…ì¸  í˜¸í™˜** | Low | High | Backward Compatibility ë³´ì¥ |
| **ë°°í¬ ì¤‘ ì¥ì• ** | Low | High | Blue-Green ë°°í¬, í—¬ìŠ¤ì²´í¬ |
| **ê²€ìƒ‰ í’ˆì§ˆ ì €í•˜** | Medium | Medium | pg_trgm Fallback (ILIKE) |

### 7.3 ë¡¤ë°± ì‹œë‚˜ë¦¬ì˜¤

#### ì‹œë‚˜ë¦¬ì˜¤ 1: Phase 0-1 ë¡¤ë°±
- **ì¡°ê±´**: CSRF/Cookie ì¸ì¦ ë¬¸ì œ
- **ì¡°ì¹˜**: Migration ë¡¤ë°±, í™˜ê²½ë³€ìˆ˜ ë³µêµ¬
- **ì˜í–¥**: ê¸°ì¡´ ì‹œìŠ¤í…œìœ¼ë¡œ ì™„ì „ ë³µêµ¬

#### ì‹œë‚˜ë¦¬ì˜¤ 2: Phase 2 ë¡¤ë°±
- **ì¡°ê±´**: Tiptap ì—ë””í„° ë¬¸ì œ
- **ì¡°ì¹˜**: Admin UIë§Œ MDEditorë¡œ ë³µêµ¬
- **ì˜í–¥**: BackendëŠ” ìœ ì§€, ì‹ ê·œ í¬ìŠ¤íŠ¸ë§Œ Markdown

#### ì‹œë‚˜ë¦¬ì˜¤ 3: ì „ì²´ ë¡¤ë°±
- **ì¡°ê±´**: ì¹˜ëª…ì  ì¥ì• 
- **ì¡°ì¹˜**: Git revert, DB ë°±ì—… ë³µêµ¬
- **ì˜í–¥**: ìµœëŒ€ 1ì‹œê°„ ë‹¤ìš´íƒ€ì„

---

## ğŸ“ˆ 8. ì„±ê³µ ì§€í‘œ

### 8.1 ê¸°ëŠ¥ ì§€í‘œ

| ì§€í‘œ | ëª©í‘œ | ì¸¡ì • ë°©ë²• |
|------|------|----------|
| **ì—ë””í„° ê¸°ëŠ¥** | Tiptap ëª¨ë“  ê¸°ëŠ¥ ì‚¬ìš© ê°€ëŠ¥ | ìˆ˜ë™ í…ŒìŠ¤íŠ¸ |
| **Backward Compatibility** | ê¸°ì¡´ í¬ìŠ¤íŠ¸ 100% í˜¸í™˜ | ìë™ í…ŒìŠ¤íŠ¸ |
| **TOC ì •í™•ë„** | Heading 100% ì¶”ì¶œ | ìë™ í…ŒìŠ¤íŠ¸ |
| **ê²€ìƒ‰ ì •í™•ë„** | í•œêµ­ì–´ ê²€ìƒ‰ ì •ìƒ ë™ì‘ | ìˆ˜ë™ í…ŒìŠ¤íŠ¸ |

### 8.2 ì„±ëŠ¥ ì§€í‘œ

| ì§€í‘œ | ëª©í‘œ | í˜„ì¬ | ì¸¡ì • ë„êµ¬ |
|------|------|------|----------|
| **HTML ë Œë”ë§** | < 100ms | - | Backend ë¡œê¹… |
| **í˜ì´ì§€ ë¡œë“œ** | < 2s (LCP) | - | Lighthouse |
| **ê²€ìƒ‰ ì‘ë‹µ** | < 500ms | - | Backend ë¡œê¹… |
| **ìºì‹œ ì ì¤‘ë¥ ** | > 90% | - | Custom ë©”íŠ¸ë¦­ |

### 8.3 ë³´ì•ˆ ì§€í‘œ

| ì§€í‘œ | ëª©í‘œ | ê²€ì¦ ë°©ë²• |
|------|------|----------|
| **XSS ë°©ì–´** | ëª¨ë“  ì…ë ¥ Sanitize | OWASP ZAP |
| **CSRF ë°©ì–´** | ëª¨ë“  Mutation ë³´í˜¸ | ìˆ˜ë™ í…ŒìŠ¤íŠ¸ |
| **CSP ì ìš©** | Violation 0ê±´ | ë¸Œë¼ìš°ì € Console |
| **ì¸ì¦ ë³´ì•ˆ** | HttpOnly Cookie | ìˆ˜ë™ ê²€ì¦ |

---

## ğŸ¯ 9. ê²°ë¡  ë° ê¶Œì¥ì‚¬í•­

### 9.1 í•µì‹¬ ì¶”ì²œ ì‚¬í•­

1. **Phase 0 ìš°ì„  ì™„ë£Œ**: ë³´ì•ˆ ê¸°ë°˜ ì—†ì´ ì—ë””í„° ì „í™˜ì€ ìœ„í—˜
2. **ì ì§„ì  ì „í™˜**: Big Bang ë°©ì§€, ê° Phaseë³„ ê²€ì¦
3. **Backward Compatibility ë³´ì¥**: ê¸°ì¡´ Markdown í¬ìŠ¤íŠ¸ ìœ ì§€
4. **ë¬¸ì„œ 6-12 ì¤€ìˆ˜**: ê²€ì¦ëœ ì„¤ê³„ íŒ¨í„´ í™œìš©
5. **ëª¨ë‹ˆí„°ë§ ìš°ì„ **: ë¬¸ì œ ì¡°ê¸° ë°œê²¬

### 9.2 ì˜ˆìƒ ì¼ì •

```
Phase 0: Week 1-2  (ë³´ì•ˆ/ì¸í”„ë¼)
Phase 1: Week 3-4  (Backend ë Œë”ë§)
Phase 2: Week 5-6  (Admin ì—ë””í„°)
Phase 3: Week 7    (ê²€ìƒ‰)
Phase 4: Week 8    (ì•ˆì •í™”)

ì´ ì˜ˆìƒ ê¸°ê°„: 8ì£¼ (2ê°œì›”)
```

### 9.3 ì˜ì‚¬ê²°ì • í•„ìš” ì‚¬í•­

| í•­ëª© | ì˜µì…˜ | ì¶”ì²œ |
|------|------|------|
| **ë°°í¬ ë°©ì‹** | Blue-Green vs Rolling | Blue-Green |
| **pg_trgm ì„¤ì¹˜** | ì¦‰ì‹œ vs Phase 3 | Phase 0 (ê°œë°œ), Phase 3 (ìš´ì˜) |
| **ê¸°ì¡´ í¬ìŠ¤íŠ¸** | ì¼ê´„ ì „í™˜ vs ìœ ì§€ | ìœ ì§€ (ì ì§„ì  ì „í™˜) |
| **ëª¨ë‹ˆí„°ë§** | Custom vs Sentry | Sentry (ì„±ìˆ™ë„) |

---

**ë¬¸ì„œ ë²„ì „**: 1.0
**ì‘ì„±ì¼**: 2025-12-30
**ë‹¤ìŒ ë‹¨ê³„**: Phase 0 ì°©ìˆ˜ ì „ ê¸°ìˆ  ìŠ¤íƒ POC ì§„í–‰ ê¶Œì¥